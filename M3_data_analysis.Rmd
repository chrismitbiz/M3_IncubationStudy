---
title: "Soils contaminated with dieldrin since three decades"
author: "CK"
date: "20/08/2020"
output: 
 bookdown::html_document2:
   toc: yes
   fig_caption: yes
   number_sections: false
editor_options: 
  chunk_output_type: console
bibliography: "library.bib"
biblio-style: "apalike"
link-citations: yes
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
  encoding=encoding,
  output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
  
---

```{r raw_peakdata_standards_dieldrin, message=FALSE, echo = FALSE, warning = FALSE}
library(reshape2)
library(lubridate)
library(tidyverse)

Sample_Peaks <- read.csv("peak_area_samples.csv", header = TRUE, row.names=NULL)
Sample_Peaks1 <- Sample_Peaks %>%  filter(!is.na(GCArea_DDD))
Sample_Peaks2 <- Sample_Peaks %>%  filter(is.na(GCArea_DDD))
  
Standards_Peaks <- read.csv("peak_area_standards.csv", header = TRUE, row.names=NULL)
Standards_Peaks_Donly <- read.csv("peak_area_standards_Donly.csv", header = TRUE, row.names=NULL)
#remove outlier
Standards_Peaks <- Standards_Peaks[-39,]

#Skip this step and only use the dieldrin calcs with corrected standards 
# calculate dieldrin concentrations from d/ddd ratios (internal standard) #
#create standard ratios and regression coefficients 
#ratio_df <- Standards_Peaks %>% mutate(InjectionDate = lubridate::dmy(Standards_Peaks$InjectionDate))  %>% mutate("0.47" = D0.47 / DDD0.47)  %>% mutate("0.094" = D0.094 / DDD0.094) %>% mutate("0.0094" = D0.0094 / DDD0.0094) %>% select(InjectionDate,"0.47", "0.094", "0.0094") %>%   reshape2::melt(data = . , measure.vars = c("0.47", "0.094","0.0094"))
#make variable numeric
#mapping <- c("0.47" = 0.47, "0.094" = 0.094, "0.0094" = 0.0094)
#ratio_df$variable <- mapping[ratio_df$variable]

#model regression for each injection date and create table with coefficients
#require(broom)
#intercept_slope <- ratio_df %>%   group_by(InjectionDate) %>%   nest() %>% mutate(model = map(data, ~lm(variable ~ value, data = .) %>%  tidy)) %>%  unnest(model) %>%  select(InjectionDate,estimate, term) %>%  pivot_wider(names_from = term, values_from = estimate) 

# get sample ratios and add the regression results and dieldrin concentrations
# Sample_Peaks1 <- Sample_Peaks1 %>% mutate(InjectionDate = lubridate::dmy(Sample_Peaks1$InjectionDate)) %>%inner_join(intercept_slope, by = c("InjectionDate" = "InjectionDate")) %>% mutate(Splratio = GCArea_Dieldrin / (GCArea_DDD * 0.98)) %>%mutate(Dieldrin = (Splratio * value + `(Intercept)`) * 12) %>% dplyr::select(-value, -`(Intercept)`)


# Do the same again but with ratios corrected for changes in means (standards have changed over time)
#  create standard ratios and regression coefficients
ratio_cor_df <- Standards_Peaks %>%
  mutate(InjectionDate = lubridate::dmy(Standards_Peaks$InjectionDate))%>%
  mutate("0.47" = ( ( (DDD0.47 / mean(DDD0.47)) - (D0.47 /  mean(D0.47))+1 )) * (D0.47 / DDD0.47) )  %>%
  mutate("0.094" = ( ( (DDD0.094 / mean(DDD0.094)) - (D0.094 /  mean(D0.094))+1 )) * (D0.094 / DDD0.094) ) %>%
  mutate("0.0094" = ( ( (DDD0.0094 / mean(DDD0.0094)) - (D0.0094 /  mean(D0.0094))+1 )) * (D0.0094 / DDD0.0094) ) %>%
  select(InjectionDate,"0.47", "0.094", "0.0094") %>%
  melt(data = . , measure.vars = c("0.47", "0.094","0.0094"))
#make variable numeric
mapping <- c("0.47" = 0.47, "0.094" = 0.094, "0.0094" = 0.0094)
ratio_cor_df$variable <- mapping[ratio_cor_df$variable]
#model regression for each injection date and create table with coefficients
require(broom)
intercept_slope <- ratio_cor_df %>% 
  group_by(InjectionDate) %>% 
  nest()%>%
  mutate(model = map(data, ~lm(variable ~ value, data = .) %>% 
                       tidy)) %>% 
  unnest(model) %>% 
  select(InjectionDate,estimate, term) %>% 
  pivot_wider(names_from = term, values_from = estimate) 

# get sample ratios and add the regression results and dieldrin concentrations
Sample_Peaks1 <- Sample_Peaks1 %>% 
  mutate(InjectionDate = lubridate::dmy(Sample_Peaks1$InjectionDate))  %>%
  inner_join(intercept_slope, by = c("InjectionDate" = "InjectionDate")) %>% mutate(Splratio = GCArea_Dieldrin / (GCArea_DDD * 0.98)) %>% mutate(Dieldrin = (Splratio * value + `(Intercept)`) * 12) %>% dplyr::select(-value, -`(Intercept)`) %>% dplyr::select(-Splratio)
# 1 ml analysed of 12 ml extracts


# Calculate dieldrin concentrations from those measurements where no internal standard was available #
# The standard curve for the 05th March standards was created based on average values across 04th-05th March, see standards_history.xls 
std_df <- Standards_Peaks_Donly %>%
  mutate(InjectionDate = lubridate::dmy(Standards_Peaks_Donly$InjectionDate))  %>%
  mutate("0.47" = D0.47)  %>%
  mutate("0.094" = D0.094 ) %>%
  mutate("0.0094" = D0.0094) %>%
  select(InjectionDate,"0.47", "0.094", "0.0094") %>%
    reshape2::melt(data = . , measure.vars = c("0.47", "0.094","0.0094"))
#make variable numeric
mapping <- c("0.47" = 0.47, "0.094" = 0.094, "0.0094" = 0.0094)
std_df$variable <- mapping[std_df$variable]
#model regression for each injection date and create table with coefficients
require(broom)
intercept_slope <- std_df %>% 
  group_by(InjectionDate) %>% 
  nest() %>%
  mutate(model = map(data, ~lm(variable ~ value, data = .) %>% 
                       tidy)) %>% 
  unnest(model) %>% 
  select(InjectionDate,estimate, term) %>% 
  pivot_wider(names_from = term, values_from = estimate) 

Sample_Peaks2 <- Sample_Peaks2 %>% 
  mutate(InjectionDate = lubridate::dmy(Sample_Peaks2$InjectionDate))  %>%
  inner_join(intercept_slope, by = c("InjectionDate" = "InjectionDate")) %>% 
  mutate(Dieldrin = (GCArea_Dieldrin * value + `(Intercept)`) * 12) %>% dplyr::select(-value, -`(Intercept)`)
# 1 ml analysed of 12 ml extracts

# Combine Sample_peaks1 and 2 (So dieldrin values from internal standards plus earlier measurements without internal standards)

Sample_Peaks <- rbind(Sample_Peaks1, Sample_Peaks2)

#Final output for graphing
```
  
  
```{r dataCO2, message=FALSE, echo = FALSE, warning = FALSE}
library(reshape2)
library(lubridate)
library(tidyverse)
library(hrbrthemes)
library(ggpubr)
library(tidyverse)
library(rstatix)
dataCO2 <- read.csv("dataCO2.csv", header = TRUE, row.names=NULL)
dataCO2 <-dataCO2 %>%  dplyr::mutate_all(type.convert) %>% dplyr::mutate_if(is.factor, as.character) 

dataCO2$Treatment[dataCO2$Treatment == "AutoclavedControl"] <- "Heat"
dataCO2 <- dataCO2 %>% mutate(Week_int = case_when(Week == "T02" ~ 02,
                              Week == "T04" ~ 04,
                              Week == "T06" ~ 06,
                              Week == "T08" ~ 08,
                              Week == "T10" ~ 10,
                              Week == "T12" ~ 12,
                              Week == "T14" ~ 14,
                              Week == "T16" ~ 16,
                              Week == "T42" ~ 42,
                              Week == "T44" ~ 44,
                              Week == "T46" ~ 46,
                              Week == "T48" ~ 48,
                              Week == "T52" ~ 52,
                              TRUE ~0))
dataCO2 <- dataCO2 %>% convert_as_factor(Samples, Treatment, Replicate, Week, Category)
#order factors
dataCO2$Treatment <- factor(dataCO2$Treatment, levels=c("Control", "Lime", "PoultryLitter", "Biochar", "CitricAcid", "Inositol", "SodiumFormate", "SodiumAcetate","FumaricAcid", "Heat","H2O2"))

# Create a df with accumulated respiration for T0-T16
CO2cum <- dataCO2  %>% select(Samples, Week, µgCO2.Cgsoil) %>% tidyr::pivot_wider(names_from= c(Week), values_from = µgCO2.Cgsoil) %>% column_to_rownames("Samples") %>% mutate(T04_cum = T02 + T04) %>% mutate(T06_cum = T04_cum + T06) %>% mutate(T08_cum = T06_cum + T08) %>% mutate(T10_cum = T08_cum + T10)  %>% mutate(T12_cum = T10_cum + T12) %>% mutate(T14_cum = T12_cum + T14) %>% mutate(T16_cum = T14_cum + T16)  %>% rownames_to_column("Samples") %>% dplyr::select(Samples, T02, T04_cum,T06_cum, T08_cum, T10_cum, T12_cum, T14_cum, T16_cum) %>% pivot_longer(names_to = "Week",  cols = T02:T16_cum)  %>% dplyr::mutate_all(type.convert) %>% arrange(Week, Samples)

data_part1 <- dataCO2 %>% rownames_to_column("id") %>% filter(id %in% 1:nrow(CO2cum)) %>% mutate(µgCO2gsoilcum = CO2cum$value)

# Create a df with accumulated respiration for T40-T52
CO2cum <- dataCO2  %>% select(Samples, Week, µgCO2.Cgsoil) %>% tidyr::pivot_wider(names_from= c(Week), values_from = µgCO2.Cgsoil) %>% column_to_rownames("Samples") %>% mutate(T44_cum = T42 + T44) %>% mutate(T46_cum = T44_cum + T46) %>% mutate(T48_cum = T46_cum + T48) %>% mutate(T52_cum = T48_cum + T52) %>% rownames_to_column("Samples") %>% dplyr::select(Samples, T42, T44_cum,T46_cum, T48_cum, T52_cum) %>% pivot_longer(names_to = "Week",  cols = T42:T52_cum)  %>% dplyr::mutate_all(type.convert) %>% arrange(Week, Samples)

data_part2 <- dataCO2 %>% rownames_to_column("id") %>% filter(id %in% 353:nrow(dataCO2)) %>% mutate(µgCO2gsoilcum = CO2cum$value)


CO2cum <- dataCO2  %>% select(Samples, Week, µgCO2.Cgsoil) %>% tidyr::pivot_wider(names_from= c(Week), values_from = µgCO2.Cgsoil) %>% column_to_rownames("Samples") %>% mutate(T04_cum = T02 + T04) %>% mutate(T06_cum = T04_cum + T06) %>% mutate(T08_cum = T06_cum + T08) %>% mutate(T10_cum = T08_cum + T10)  %>% mutate(T12_cum = T10_cum + T12) %>% mutate(T14_cum = T12_cum + T14) %>% mutate(T16_cum = T14_cum + T16) %>% mutate(T42_cum = T16_cum + T42) %>% mutate(T44_cum = T42_cum + T44) %>% mutate(T46_cum = T44_cum + T46) %>% mutate(T48_cum = T46_cum + T48) %>% mutate(T52_cum = T48_cum + T52) %>% rownames_to_column("Samples") %>% dplyr::select(Samples, T02, T04_cum,T06_cum, T08_cum, T10_cum, T12_cum, T14_cum, T16_cum, T42_cum, T44_cum,T46_cum, T48_cum, T52_cum) %>% pivot_longer(names_to = "Week",  cols = T02:T52_cum)  %>% dplyr::mutate_all(type.convert) %>% arrange(Week, Samples)

data_part2.2 <- dataCO2 %>% rownames_to_column("id") %>% filter(id %in% 1:nrow(dataCO2)) %>% mutate(µgCO2gsoilcum = CO2cum$value)
```

 
# Method briefly: 
A paddock consisting of organic matter rich pasture soil with high residue concentrations of the legacy pollutant dieldrin was sampled in August 2018 (0-10 cm). Dieldrin was the main use of control for the 'name?' beetle in potato cropping until 1987. Total dieldrin dissipation in this surface soil was 50% since 1988 and remaining extractable residues in 2017 were 1.16 µg g-1 soil dry weight (± 0.07 SE) [@Krohn2019]. Minor concentrations of dichlorodiphenyltrichloroethane including its congener dichlorodiphenyldichloroethylene were also detected (0.11 µg g-1 soil dry weight (± 0.01 SE) [@Krohn2019].  
  
Soil was air dried in bags overnight, sieved (4 mm) and waterholding capacity (10 kPa) measured the next day. Two days after field sampling the water content (16 hrs at 105˚C) was measured and 12 treatments applied in zip-lock bags at 80% of waterholding capacity, and 228 g of each treatment divided into four jars with a total of 44 jars for all treatments. Soils in jars were sampled at T0, T2, T4, T8, T16, T39 and T52 and stored at -20˚C until further processed. 
  
44 jars of a soil contaminated with dieldrin since three decades were treated and incubated for a total of twelve months (Twelve treatments with four replicates). Dieldrin concentrations were measured at four times (T0, T16, T39, T52 - Weeks after treatments).

Analysis was done in two parts:  
- **T0－T39**     From day of treatment to 9 months after treatment  
- **T39－T52**    New treatment at 9 months and incubated for another 3 months reaching a total of 12 months. The new treatment was 'ploughing', i.e. aggregates were broken up. Additionally the organic substrates were re-applied. 
  
# Result highlights  
- Addition of labile carbon appeared to inhibit dieldrin dissipation  
  - In general, the more microorganisms respired the less dieldrin dissipated.  
  - High respiration further resulted in lowest C:N ratios at the end - indicating processing of the labile Carbon
- Poultry litter inhibited dieldrin dissipation while poultry litter biochar did not 
- Soils treated with poultry litter biochar contained lowest extractable dieldrin residues at the end of the incubation  
- After re-applying the organic substrates in week 39, high respiration again correlated with low dieldrin dissipation 
- Fumaric acid was an exception. It somehow suppressed respiration after 2nd application in week 39 and also suppressed dieldrin loss from week 39 onward 
- The initial respiration response to treatments was most indicative for dieldrin dissipation as the strongest correlations of accumulated respiration was in week 4 - 8. In other words where microbes respired the most after treatment, the least dieldrin dissipated.  


```{r boxplotsWATER, fig.width=10, fig.asp=0.8, message=FALSE, echo = FALSE, warning = FALSE, cache=TRUE, include = FALSE, fig.cap="Boxplots of watercontent."}

# Boxplot water content by week
data_noref  %>% 
  #filter(SampleName != "t0_4.run" ) %>% 
  ggboxplot(data = ., x = "Week", y = "H20", ylab = "H20 (Θg)", add = "jitter", fill = "Week", palette = "simpsons", xlab = FALSE, add.params = list(shape = 20, color = "Category")) + rotate_x_text(angle = 45) + ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T0", hide.ns = TRUE) + stat_compare_means(label.y = 0.41, method = "kruskal")  + scale_fill_manual(values=c("gold1", "cornflowerblue", "azure4", "burlywood3"))+ labs(colour = "")

```


# Dieldrin concentrations summary
```{r dataoverview, fig.width=10, fig.asp=0.4, message=FALSE, echo = FALSE, warning = FALSE, cache=FALSE, include=TRUE}
library(hrbrthemes)
library(ggpubr)
library(tidyverse)
library(rstatix)

data <- Sample_Peaks %>% rename(Week = "TWeeks") %>% filter(SampleName != "t0__40_e2c1001")

data$Treatment[data$Treatment == "AutoclavedControl"] <- "Heat"
data$Treatment[data$Treatment == "ref_garretto"] <- "Reference"
data <- data  %>% filter(Project != "M4")
data <- data %>% mutate(Week_int = case_when(Week == "T16" ~ 16,
                              Week == "T39" ~ 39,
                              Week == "T52" ~ 52,
                              Week == "re" ~ 0,
                              TRUE ~0) )
data <- data %>% mutate(Category = case_when(Treatment == "Control" ~ "Control",
                                             Treatment == "Reference" ~ "Reference",
                              TRUE ~ "Treatment") )

data <- data %>% convert_as_factor(SampleID, SampleNo, Replicate)
#order factors
data$Treatment <- factor(data$Treatment, levels=c("Reference","Control", "Lime", "PoultryLitter", "Biochar", 
                                                                "CitricAcid", "Inositol", "SodiumFormate", "SodiumAcetate",
                                                                "FumaricAcid", "Heat","H2O2"))
#data$Category <- factor(data$Category, levels=c("Control","AGamend", "Csubstrate", "Stress"))
data$Week <- factor(data$Week, levels=c("re", "T0","T16", "T39", "T52"))
data  <- data %>% arrange(Week, SampleNo)
data$Dieldrin_trans <- log(data$Dieldrin)

# outliers
#data %>%
#  group_by(Week) %>%
#  rstatix::identify_outliers(Dieldrin) %>% select(Week,Treatment, Dieldrin, is.outlier, is.extreme)
#identified sample 04 (control) as extreme outlier

T0 <- data %>% filter(Week == "T0")
T16 <- data %>% filter(Week == "T16")
T39 <- data %>% filter(Week == "T39")
T52 <- data %>% filter(Week == "T52")

## Create a df that excludes the references 
data_noref <- data %>% dplyr::filter(Treatment != "Reference") %>% 
  mutate(T0_Diff = Dieldrin / T0$Dieldrin * 100) %>% 
  mutate(T39_Diff = Dieldrin / T39$Dieldrin * 100) %>% 
  mutate(loss = (T0$Dieldrin - Dieldrin) /  T0$Dieldrin * 100) %>% 
  mutate(loss39 = (T39$Dieldrin - Dieldrin) /  T39$Dieldrin * 100) 

# Include the watercontent values and create water loss columns
H20 <- read.csv("~/Documents/Study/LaTrobe/Research/phD/Milestone3/M3_IncubationStudy/data.csv") %>% select(H20)
data_noref$H20 <- H20$H20
data_noref <- data_noref %>% 
  mutate(H20_losssinceT0 = (((data_noref %>% filter(Week == "T0") %>% select(H20))$H20) - H20) / (data_noref %>% filter(Week == "T0") %>% select(H20))$H20 *100) %>% 
  mutate(H20_losssinceT39 = (((data_noref %>% filter(Week == "T39") %>% select(H20))$H20) - H20) / (data_noref %>% filter(Week == "T39") %>% select(H20))$H20 *100)  
  
data_fltrd  <- data_noref %>% 
 # filter(SampleName != "t0_4.run") %>% 
  filter(Treatment != "Reference")

## Models to test if concentrations differ between weeks
intercept <- mean(T0$Dieldrin[-4])
mod2 <- lm(I((Dieldrin) - intercept) ~  Week, data = data_fltrd)
#summary(mod2)
#car::Anova(mod2, type = 3)

#df <- data_noref %>% filter(Week != "T0")
#shapiro.test(df$T0_Diff)
#mod1 <- lm(log1p(T0_Diff) ~ Week, data = df)
#summary(mod1)
#car::Anova(mod, type = 3)
#intercept <- 1
#mod2 <- lm(I((T0_Diff) - intercept) ~  Week, data = df)
#summary(mod2)
#car::Anova(mod2, type = 3)

#intercept <- mean(T0$Dieldrin[-4])
#mod <- lm(Dieldrin_trans ~  Treatment*Week, data = data_fltrd)
#summary(mod)
#car::Anova(mod2, type = 3)


# Summary mean and sd
options(knitr.kable.NA = '')
kableExtra::kable(data %>% 
                    #filter(SampleName != "t0_4.run" ) %>%
  group_by(Week) %>%
  rstatix::get_summary_stats(Dieldrin, type = "mean_se")) %>% kableExtra::kable_styling(full_width = F, position = "left",bootstrap_options = c( "condensed"), font_size = 11 )

shapiro_test(data_noref$Dieldrin)
```

```{r comparisonof201517withcurrent, echo = FALSE, warning = FALSE, include=FALSE}
metadata<- readr::read_tsv("~/Documents/Study/LaTrobe/Research/phD/Milestone2_Field_Survey/M2_Bacteria/M2_Qiime_output_Bacteria2020run/metadata.tsv") 

metadata2 <- metadata[c(2:nrow(metadata)),c(1:length(metadata))] %>%
  tibble::rownames_to_column("spl") %>%
  dplyr::mutate_all(type.convert) %>%
  dplyr::mutate_if(is.factor, as.character) %>%
  tibble::column_to_rownames("spl")

# Summary stats of the three replicates from paddock 11 (12AcrePaddock), Dieldrin values are the mean from 2015 and 2017 measurements
df <- metadata2 %>% filter(Paddock == 11) %>% select(Farm, D1517, DDT1517, Dloss)
rstatix::get_summary_stats(df)

# Compare with new samples from August 2018 of the same paddock
rstatix::get_summary_stats(data_fltrd %>% filter(Treatment == "Control") %>% filter(Week == "T0") %>% select(Dieldrin))
# Result: The total dieldrin concentration of the control in 2018 was within 3.3% of the measurements from 2015/2017.
# This validated the dieldrin extraction method and GCECD method employed in the LaTrobe/DJPR lab is comparable to the National Measurement Institute. 
```

```{r boxplotsfig1, fig.width=10, fig.asp=0.8, message=FALSE, echo = FALSE, warning = FALSE, cache=TRUE, fig.cap="Boxplots of dieldrin concentrations and dieldrin concentrations relative to start of experiment (T0), including histograms."}

p1.1 <- data_noref %>% 
  filter(Week != "T0") %>% 
  #filter(SampleNo != 4 ) %>%
  filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" ) %>% # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
  ggboxplot(data = ., x = "Week", y = "T0_Diff", ylab = "Residue remaining since T0 (%)",  add = "jitter", fill = "Week", palette = "simpsons", xlab = FALSE) +  
  rotate_x_text(angle = 45) + 
  stat_compare_means( method = "kruskal")   + 
  scale_fill_manual(values=c("cornflowerblue", "azure4", "burlywood3" )) + 
  ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T16", hide.ns = TRUE)

#histogram
p2.1 <- data_noref  %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" ) %>% # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
  filter(Week != "T0") %>% 
  gghistogram(data =., x= "T0_Diff", fill = "Week", facet.by = "Week",add = "mean", rug = TRUE) + 
  scale_fill_manual(values=c("cornflowerblue", "azure4", "burlywood3")) + 
  scale_color_manual(values=c("cornflowerblue", "azure4", "burlywood3"))+ 
  theme(legend.position = "none")


# Boxplot dieldrin cc by week
p1.2 <- data  %>% 
  #filter(SampleName != "t0_4.run" ) %>%
  filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" ) %>% # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
  ggboxplot(data = ., x = "Week", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = "jitter", fill = "Week", palette = "simpsons", xlab = FALSE, add.params = list(shape = 20, color = "Category")) + 
  rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T0", hide.ns = TRUE) + 
  stat_compare_means(label.y = 1.25, method = "kruskal")  + 
  scale_fill_manual(values=c("gray80","gold1", "cornflowerblue", "azure4", "burlywood3"))+ 
  labs(colour = "")

#histogram
p2.2 <- data  %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" ) %>% # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
  gghistogram(data =., x= "Dieldrin", fill = "Week", palette = "simpsons", facet.by = "Week",add = "mean", rug = TRUE) + 
  scale_fill_manual(values=c("gray80","gold1", "cornflowerblue", "azure4", "burlywood3")) + 
  labs(colour = "") + 
  theme(legend.position = "none")

ggarrange(p1.2, p2.2, p1.1, p2.1, ncol = 2, nrow = 2, common.legend = TRUE)


#p1 <- Sample_Peaks1 %>% filter(SampleNo != 4 ) %>% ggboxplot(data = ., x = "TWeeks", y = "Dieldrin", ylab = "calcualted dieldrin cc",  add = "jitter", fill = "TWeeks", palette = "simpsons", xlab = FALSE) +  rotate_x_text(angle = 45) + stat_compare_means( method = "kruskal")   + ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T0", hide.ns = TRUE)

#p2 <- Sample_Peaks1 %>% filter(SampleNo != 4 ) %>% ggboxplot(data = ., x = "TWeeks", y = "GCArea_Dieldrin", ylab = "GC AREA for dieldrin",  add = "jitter", fill = "TWeeks", palette = "simpsons", xlab = FALSE) +  rotate_x_text(angle = 45) + stat_compare_means( method = "kruskal")   + ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T0", hide.ns = TRUE)

#p3 <- Sample_Peaks1 %>% filter(SampleNo != 4 ) %>% ggboxplot(data = ., x = "TWeeks", y = "GCArea_DDD", ylab = "GC AREA for DDD",  add = "jitter", fill = "TWeeks", palette = "simpsons", xlab = FALSE) +  rotate_x_text(angle = 45) + stat_compare_means( method = "kruskal")   + ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T0", hide.ns = TRUE)


```
  
- Across all treatments there was no significant change in the mean concentrations after 9 month (39 weeks after treatment). However, in the last 3 months from T39 to T52 the mean concentration dropped by 9.5% (from 1.05 to 0.95 µg g^1^).  
  
- The soil in the no-treatment control contained the highest concentrations and remained highest over time (with exception for T16). The dieldrin concentrations of the reference soil (airdried bulk soil) was at a similar level to the no-treatment control.  
  
- The cause of this drop is likely related to the 'ploughing' of soils in the jars at T39. The incubation was not meant to go for 12 month and after 9 month of no change in concentration I decided to carefully break down all soil aggregated with a spoon and further re-treat the organic substrates (citric acid, inositol, fumaric acid, sodium formate and sodium acetate). As the 9.5 % drop in dieldrin concentration was across the board I suspected that it was related to the mixing of soil. 
  
- The distribution of concentrations appears to be normal for T0, T39 and T52 but not for T16.
  


```{r boxplfig2, echo=FALSE, fig.width=10, fig.asp=1,  message=FALSE, cache=TRUE, warning = FALSE, fig.cap="Boxplots of dieldrin concentrations by treatment, week/treatment (a) and treatment/week (b). Letters above boxplots indicate significantly different means at an 0.05 level (Fisher's least significant difference, holms corrected)."}

# Boxplot dieldrin cc by treatment with sig. labels
df1 <- data_noref  %>% 
  #filter(SampleName != "t0_4.run" ) %>% 
  filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" )  # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
df1$Treatment <- factor(df1$Treatment)
kr.test <- with(df1,agricolae::kruskal(Dieldrin,Treatment,group=TRUE, p.adj="holm"))
levels  <- levels(df1$Treatment) %>% as.data.frame()
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)

#p1 <- data_noref %>% filter(SampleName != "t0_4.run" ) %>% ggboxplot(data = ., x = "Treatment", y = "Dieldrin",  ylab = "Dieldrin (µg/g) across all timepoints", add = "jitter", fill = "Treatment", palette = "simpsons", xlab = FALSE) + rotate_x_text(angle = 45) + stat_compare_means(label.y = 1.25, method = "kruskal")   + annotate("text", x = groups1$Treatment, y=c(1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3), label = label)

p2 <- ggboxplot( data_fltrd %>% 
                   filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
                   filter(SampleName != "averageofthree" ), # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
                    x = "Treatment", y = "Dieldrin_trans",  ylab = "Dieldrin (log)", fill = "Week", palette = "simpsons") + rotate_x_text(angle = 45)

p3 <- ggboxplot( data_fltrd %>% 
                   filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
                   filter(SampleName != "averageofthree" ), # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed 
                 x = "Week", y = "Dieldrin_trans", ylab = "Dieldrin (log)", fill = "Treatment", palette = "simpsons")+ rotate_x_text(angle = 45)
                 
ggarrange(ggarrange(p3,ncol = 1, common.legend = TRUE), p2, ncol = 1, heights = c(0.5, 0.5), labels = "auto")


#ggboxplot( Sample_Peaks1, x = "TWeeks", y = "GCArea_Dieldrin",  ylab = "GCArea_Dieldrin", fill = "Treatment", palette = "simpsons") + rotate_x_text(angle = 45)

#ggboxplot( Sample_Peaks1, x = "TWeeks", y = "GCArea_DDD",  ylab = "GCArea_DDD", fill = "Treatment", palette = "simpsons") + rotate_x_text(angle = 45)
#ggboxplot( Sample_Peaks1, x = "Treatment", y = "GCArea_DDD",  ylab = "GCArea_DDD", fill = "TWeeks", palette = "simpsons") + rotate_x_text(angle = 45)
```

```{r lineplotfig3, fig.width=8, fig.asp=1.1,  message=FALSE, echo = FALSE, cache=FALSE, warning = FALSE, fig.cap="Dieldrin concentrations (log) across time. Error bars show the standard error of the mean of four replicates."}

l0 <- data_noref %>% 
  #filter(SampleName != "t0_4.run" ) %>%
   filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" ) %>% # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
  ggpubr::ggline(data = ., x = "Week_int", y = "Dieldrin_trans", ylab = "Dieldrin (log)", add = c("mean_se"), color = "Treatment", palette = "simpsons") + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

#l01 <- data  %>% filter(SampleNo != 4 ) %>% ggline(data = ., x = "Week_int", y = "T0_Diff", add = c("mean_se"), color = "Treatment", palette = "simpsons") + rotate_x_text(angle = 45) + stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

s0 <- data_noref %>% 
  #filter(SampleName != "t0_4.run" ) %>%
   filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied
  filter(SampleName != "averageofthree" ) %>% # removing T16_31 (Sodium formate), this was measured without internal standard and failed
  ggpubr::ggscatter(data = ., x = "Week_int", y = "Dieldrin_trans", ylab = "Dieldrin (log)", add = "reg.line", color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

pdf(NULL)
g1 <- ggpubr::ggarrange(l0, s0, nrow = 2, ncol=1, common.legend = TRUE)
x = dev.off()
g1

```

  
The treatment-comparison of dieldrin concentrations showed that biochar and the heat treatment were significantly lower compared to the control and all other treatments. It was also apparent the the biochar and heat treatment contained soil with lowest dieldrin concentrations from the start of the experiment. This meant that the effect of these treatments was immediate. For biochar this could be explained by lower extractability of dieldrin due to immediate sorption to biochar. 

# CHN data
```{r dataCHN, message=FALSE, echo = FALSE, warning = FALSE, include=FALSE, eval=TRUE}

dataCHN <- read.csv("~/Documents/Study/LaTrobe/Research/phD/Milestone3/Data_TC/data_TC.csv", header = TRUE, row.names=NULL)
dataCHN <- dataCHN %>% dplyr::filter(WAT %in% c("T0", "T16", "T39","T52"))
dataCHN$Treatment[dataCHN$Treatment == "AutoclavedControl"] <- "Heat"
dataCHN  <- dataCHN %>% dplyr::select(SampleNo, Treatment, WAT, Date, C, H, N)
dataCHN <- dataCHN %>%  dplyr::mutate_all(type.convert) %>% dplyr::mutate_if(is.factor, as.character) %>% rename(Week = "WAT")
dataCHN <- dataCHN %>% mutate(Week_int = case_when(Week == "T16" ~ 16,
                              Week == "T39" ~ 39,
                              Week == "T52" ~ 52,
                              TRUE ~0))
dataCHN$C <- dataCHN$C *100
dataCHN$N <- dataCHN$N *100
dataCHN$H <- dataCHN$H *100

dataCHN <- dataCHN %>% rstatix::convert_as_factor(SampleNo, Treatment, Week)
#order factors
dataCHN$Treatment <- factor(dataCHN$Treatment, levels=c("Control", "Lime", "PoultryLitter", "Biochar", "CitricAcid", "Inositol", "SodiumFormate", "SodiumAcetate","FumaricAcid", "Heat","H2O2"))

## Add column with CN ratio and HC ratio
dataCHN <- dataCHN %>% as_tibble() %>% 
  dplyr::mutate(CN = (C / N)) %>% 
  dplyr::mutate(HC = (H / C)) 

## Add column with C losses
T0_C <- dataCHN %>% filter(Week == "T0")
T16_C <- dataCHN %>% filter(Week == "T16")
T39_C <- dataCHN %>% filter(Week == "T39")
T52_C <- dataCHN %>% filter(Week == "T52")
dataCHN <- dataCHN %>% 
  mutate(Closs = (T0_C$C - C)) 


```

```{r, plotsCHNT52, message=FALSE, echo = FALSE, warning = FALSE, include=FALSE, eval=FALSE}

## Boxplots of CN, Week 52
kr.test <- with(dataCHN %>% filter(Week == "T52") , agricolae::kruskal(CN,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
CNplot <- dataCHN %>% 
  #filter(Week %in% c("T0","T52")) %>% 
  filter(Week %in% c("T52")) %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "CN",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 15 ) +
  annotate("text", x = groups1$Treatment, y=c(14.7,14.7,14.7,14.7,14.7,14.7,14.7,14.7,14.7,14.7,14.7), label = label) + 
  ggtitle("C:N ratio from T52")


## Boxplots of HC, Week 52
kr.test <- with(dataCHN %>% filter(Week == "T52") , agricolae::kruskal(HC,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
HCplot <- dataCHN %>% 
  #filter(Week %in% c("T0","T52")) %>% 
  filter(Week == "T52") %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "HC",  fill = "Treatment", palette = "simpsons", 
                    legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 0.265 ) +
  annotate("text", x = groups1$Treatment, y=c(0.26,0.26,0.26,0.26,0.26,0.26,0.26,0.26,0.26,0.26,0.26), label = label) + 
  ggtitle("H:C ratio from T52")



## Boxlplots of C
kr.test <- with(dataCHN %>% filter(Week == "T52") , agricolae::kruskal(C, Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
Cplot <- dataCHN %>% 
  #filter(Week %in% c("T0","T52")) %>%  
  filter(Week == "T52") %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "C",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 6 ) +
  annotate("text", x = groups1$Treatment, y=c(5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8), label = label) + 
  ggtitle("Carbon (%) at T52")



## Boxlplots of N
kr.test <- with(dataCHN, agricolae::kruskal(N,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
Nplot <- dataCHN %>% 
  filter(Week == "T52") %>% 
  filter(Week %in% c("T52")) %>%
  ggpubr::ggboxplot(data =., x = "Treatment", y = "N",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 0.46) +
  annotate("text", x = groups1$Treatment, y=c(0.45,0.45,0.45,0.45,0.45,0.45,0.45,0.45,0.45,0.45,0.45), label = label) + 
  ggtitle("Nitrogen (%) at T52")


## Boxlplots of H
kr.test <- with(dataCHN, agricolae::kruskal(H,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
Hplot <- dataCHN %>% 
  filter(Week == "T52") %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "H",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 1.3) +
  annotate("text", x = groups1$Treatment, y=c(1.28,1.28,1.28,1.28,1.28,1.28,1.28,1.28,1.28,1.28,1.28), label = label) + 
  ggtitle("Hydrogen (%) at T52")

## Boxplots C loss
Clossplot <- dataCHN %>% 
  filter(Week == "T52") %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "Closs",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal")
  ggtitle("Dieldrin loss from T0 to T39")
  

ggpubr::ggarrange(CNplot, HCplot, Cplot, Nplot, Hplot, Clossplot)

```

```{r dplotsCHNT0, message=FALSE, echo = FALSE, warning = FALSE, include=FALSE, eval=FALSE}
## Boxplots of CN, Week 0
kr.test <- with(dataCHN %>% filter(Week == "T0") , agricolae::kruskal(CN,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
CNplot <- dataCHN %>% 
  #filter(Week %in% c("T0","T52")) %>% 
  filter(Week %in% c("T0")) %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "CN",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 15 ) +
  annotate("text", x = groups1$Treatment, y=c(14.7,14.7,14.7,14.7,14.7,14.7,14.7,14.7,14.7,14.7,14.7), label = label) + 
  ggtitle("C:N ratio from T0")



## Boxplots of HC, Week 0
kr.test <- with(dataCHN %>% filter(Week == "T0") , agricolae::kruskal(HC,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
HCplot <- dataCHN %>% 
  #filter(Week %in% c("T0","T52")) %>% 
  filter(Week == "T0") %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "HC",  fill = "Treatment", palette = "simpsons", 
                    legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 0.265 ) +
  annotate("text", x = groups1$Treatment, y=c(0.26,0.26,0.26,0.26,0.26,0.26,0.26,0.26,0.26,0.26,0.26), label = label) + 
  ggtitle("H:C ratio from T0")



## Boxlplots of C
kr.test <- with(dataCHN %>% filter(Week == "T0") , agricolae::kruskal(C, Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
Cplot <- dataCHN %>% 
  #filter(Week %in% c("T0","T52")) %>%  
  filter(Week == "T0") %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "C",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 6 ) +
  annotate("text", x = groups1$Treatment, y=c(5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8), label = label) + 
  ggtitle("Carbon (%) at T0")

#Cplot <- dataCHN %>% 
  #filter(Week %in% c("T0","T52")) %>%  
#  filter(Week == "T0") %>% 
#  ggpubr::ggbarplot(data =., x = "Treatment", y = "C",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE) + 
#  ggpubr::rotate_x_text(angle = 45) + 
#  ggpubr::stat_compare_means(method = "kruskal", label.y = 6 ) +
#  annotate("text", x = groups1$Treatment, y=c(5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8,5.8), label = label) + 
#  ggtitle("Carbon (%) at T0")


## Boxlplots of N
kr.test <- with(dataCHN, agricolae::kruskal(N,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
Nplot <- dataCHN %>% 
  filter(Week == "T0") %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "N",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 0.46) +
  annotate("text", x = groups1$Treatment, y=c(0.45,0.45,0.45,0.45,0.45,0.45,0.45,0.45,0.45,0.45,0.45), label = label) + 
  ggtitle("Nitrogen (%) at T0")


## Boxlplots of H
kr.test <- with(dataCHN, agricolae::kruskal(H,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(dataCHN$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
Hplot <- dataCHN %>% 
  filter(Week == "T0") %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "H",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 1.3) +
  annotate("text", x = groups1$Treatment, y=c(1.28,1.28,1.28,1.28,1.28,1.28,1.28,1.28,1.28,1.28,1.28), label = label) + 
  ggtitle("Hydrogen (%) at T0")

## Boxplots C loss
#Clossplot <- dataCHN %>% 
#  filter(Week == "T0") %>% 
#  ggpubr::ggboxplot(data =., x = "Treatment", y = "Closs",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("jitter"), lab.vjust = -2, xlab = FALSE) + 
#  ggpubr::rotate_x_text(angle = 45) + 
#  ggpubr::stat_compare_means(method = "kruskal")
#  ggtitle("Carbon loss T0")

ggpubr::ggarrange(CNplot, HCplot, Cplot, Nplot, Hplot)


```

```{r lineplotfig5, fig.cap="CHN data overview", message=FALSE, echo = FALSE, warning = FALSE, include=TRUE, eval=TRUE, fig.width= 12, fig.asp=0.7}
#"PoultryLitter","Biochar", "Heat" , "CitricAcid", "Lime". "Inositol", "H2O2", "Heat", "SodiumFormate", "SodiumAcetate", "FumaricAcid"

df <- dataCHN %>% 
  filter(Week %in% c("T0","T39", "T52")) #%>% 
  #filter(Treatment %in% c("Control","Heat", "PoultryLitter","Biochar", "FumaricAcid"))

p1 <- df %>% 
  ggpubr::ggline(data =., x = "Week", y = "CN",  color = "Treatment", palette = "simpsons",add = c("mean_se"))+
  stat_compare_means( method = "kruskal")  

p2<- df %>%  
  ggpubr::ggline(data =., x = "Week", y = "C",  color = "Treatment", palette = "simpsons",add = c("mean_se"))+
  stat_compare_means( method = "kruskal")  

p3 <- df %>% 
  ggpubr::ggline(data =., x = "Week", y = "N",  color = "Treatment", palette = "simpsons",add = c("mean_se"))+
  stat_compare_means( method = "kruskal")  

p4 <- df %>% 
  ggpubr::ggline(data =., x = "Week", y = "HC",  color = "Treatment", palette = "simpsons",add = c("mean_se"))+
  stat_compare_means( method = "kruskal")  

p5 <-df %>% 
  ggpubr::ggline(data =., x = "Week", y = "H",  color = "Treatment", palette = "simpsons",add = c("mean_se")) +
  stat_compare_means( method = "kruskal")  


ggpubr::ggarrange(p1,p2, p3, p4, p5, common.legend = TRUE)

```

```{r barplot, message=FALSE, echo = FALSE, warning = FALSE, include=FALSE, eval=FALSE}
#"PoultryLitter","Biochar", "Heat" , ,"CitricAcid"

df <- dataCHN %>% 
  filter(Week %in% c("T0","T39", "T52")) %>% 
  filter(Treatment %in% c("CitricAcid"))



p1 <- df %>% 
  ggpubr::ggbarplot(data =., x = "Week", y = "CN",  fill = "Treatment", palette = "simpsons",add = c("mean_se"), position = position_dodge(0.9), label = TRUE, lab.nb.digits = 3) +
  stat_compare_means( method = "kruskal") 

p2 <- df %>% 
  ggpubr::ggbarplot(data =., x = "Week", y = "C",  fill = "Treatment", palette = "simpsons",add = c("mean_se"), position = position_dodge(0.9), label = TRUE, lab.nb.digits = 3)   +
  stat_compare_means( method = "kruskal") 

p3 <- df %>% 
  ggpubr::ggbarplot(data =., x = "Week", y = "N",  fill = "Treatment", palette = "simpsons",add = c("mean_se"), position = position_dodge(0.9), label = TRUE, lab.nb.digits = 3)   +
  stat_compare_means( method = "kruskal") 

p4 <- df %>% 
  ggpubr::ggbarplot(data =., x = "Week", y = "HC",  fill = "Treatment", palette = "simpsons",add = c("mean_se"), position = position_dodge(0.9), label = TRUE, lab.nb.digits = 3)   +
  stat_compare_means( method = "kruskal") 

p5 <- df %>% 
  ggpubr::ggbarplot(data =., x = "Week", y = "H",  fill = "Treatment", palette = "simpsons",add = c("mean_se"), position = position_dodge(0.9), label = TRUE, lab.nb.digits = 3) +
  stat_compare_means( method = "kruskal") 

ggpubr::ggarrange(p1,p2, p3, p4, p5, common.legend = TRUE)

```

```{r scatterplotind, message=FALSE, echo = FALSE, warning = FALSE, include=FALSE, eval=FALSE}

df <- dataCHN %>% 
  filter(Week %in% c("T0","T39", "T52")) %>% 
  filter(Treatment %in% c("Control")) #"PoultryLitter","Biochar", "Heat"


p1 <- df %>% 
  ggpubr::ggscatter(data =., x = "Week_int", y = "CN", color = "Treatment", label = "SampleNo", palette = "simpsons",add = c("reg.line")) 

p2 <- df %>% 
  ggpubr::ggscatter(data =., x = "Week_int", y = "C", color = "Treatment",  label = "SampleNo", palette = "simpsons",add = c("reg.line")) 
p3 <- df %>% 
  ggpubr::ggscatter(data =., x = "Week_int", y = "N",   color = "Treatment", label = "SampleNo", palette = "simpsons",add = c("reg.line")) 

p4 <-df %>% 
  ggpubr::ggscatter(data =., x = "Week_int", y = "H", color = "Treatment",   label = "SampleNo", palette = "simpsons",add = c("reg.line")) 

p5 <- df %>% 
  ggpubr::ggscatter(data =., x = "Week_int", y = "HC", color = "Treatment",  label = "SampleNo", palette = "simpsons",add = c("reg.line")) 


ggpubr::ggarrange(p1,p2, p3, p4, p5, common.legend = TRUE)

```

```{r, corplotCHN, message=FALSE, echo = FALSE, warning = FALSE, include=FALSE, eval=FALSE}
df0 <- data_noref %>% tidyr::unite("z", Week, Treatment, SampleNo, remove = FALSE)
df1 <- dataCHN %>% tidyr::unite("z", Week, Treatment, SampleNo, remove = FALSE)
df <- dplyr::inner_join(df0, df1, by = "z") %>% select(SampleNo.x, Week.x, Week_int.x, Treatment.x, Category, Dieldrin, Dieldrin_trans, loss, loss39, H20, H20_losssinceT0, C, H, N, CN, HC, Closs) 

df3 <- df %>% dplyr::select(-SampleNo.x,  -Week_int.x, -Category) %>% drop_na( ) %>% filter(Week.x != "T0") %>% filter(Week.x != "T16")
p1 <- ggcorrplot::ggcorrplot(cor(df3 %>% dplyr::select(-Week.x, -Treatment.x)))

p2 <- df3 %>% ggpubr::ggscatter(y = "loss", x = "H", add = "reg.line", cor.coef = TRUE, cor.method = "spearman")
p3 <- df3 %>% ggpubr::ggscatter(y = "loss", x = "H", add = "reg.line", cor.coef = TRUE, cor.method = "spearman", color = "Week.x")

ggarrange(p1, p2, p3)

```

<br/>

# Correlations 
## Accumulated respiration
```{r corplotfig5, fig.cap="Correlations of total respiration (µg CO~2~-C g^-1^ soil).", echo = FALSE, warning = FALSE, cache=TRUE, include=TRUE, fig.width=8, fig.asp=1 }
#Calculate the sum of CO2 produced per g of soil

# Total respiration, T0-T16 and T42-T52 combined
df <- data_part2.2  %>%  
  select(Samples, Week, µgCO2.Cgsoil)  %>% 
  tidyr::spread(Week, µgCO2.Cgsoil) %>% 
  column_to_rownames("Samples") %>% 
  rowSums()
df1 <- data_part2.2  %>%  
  select(Samples, Week, µgCO2gsoilcum)  %>% 
  tidyr::spread(Week, µgCO2gsoilcum) %>% 
  column_to_rownames("Samples")
df2 <- data_noref %>%  
  select(SampleNo, Week, H20_losssinceT0)  %>% 
  tidyr::spread(Week, H20_losssinceT0) %>% 
  column_to_rownames("SampleNo")
#str(data_noref)
df1 <-  df1 %>% 
  dplyr::rename(RespCumT02 = T02) %>% 
  dplyr::rename(RespCumT04 = T04) %>% 
  dplyr::rename(RespCumT06 = T06) %>% 
  dplyr::rename(RespCumT08 = T08) %>% 
  dplyr::rename(RespCumT10 = T10) %>% 
  dplyr::rename(RespCumT12 = T12) %>% 
  dplyr::rename(RespCumT14 = T14) %>% 
  dplyr::rename(RespCumT16 = T16) %>% 
  dplyr::rename(RespCumT42 = T42) %>% 
  dplyr::rename(RespCumT44 = T44) %>% 
  dplyr::rename(RespCumT46 = T46) %>% 
  dplyr::rename(RespCumT48 = T48) %>% 
  dplyr::rename(RespCumT52 = T52)

## Difference of Soil variables from T0 to T52
C_diff <- (dataCHN %>% filter(Week == "T52") %>% select(C)) - (dataCHN %>% filter(Week == "T0") %>% select(C))
CN_diff <- (dataCHN %>% filter(Week == "T52") %>% select(CN)) - (dataCHN %>% filter(Week == "T0") %>% select(CN))
C_diff <- (dataCHN %>% filter(Week == "T52") %>% select(C)) - (dataCHN %>% filter(Week == "T0") %>% select(C))
H_diff <- (dataCHN %>% filter(Week == "T52") %>% select(H)) - (dataCHN %>% filter(Week == "T0") %>% select(H))
HC_diff <- (dataCHN %>% filter(Week == "T52") %>% select(HC)) - (dataCHN %>% filter(Week == "T0") %>% select(HC))
H <- dataCHN %>% filter(Week == "T52") %>% select(H)
HC <- dataCHN %>% filter(Week == "T52") %>% select(HC)
CN <- dataCHN %>% filter(Week == "T52") %>% select(CN)
C <- dataCHN %>% filter(Week == "T52") %>% select(HC)

#Create a df to compare the sum of CO2 produced with other variables
df <- data.frame(Treatment = data_part1[c(1:44),]$Treatment,
                 H  = H$H,
                 HC  = HC$HC,
                 CN  = CN$CN,
                 C_diff = C_diff$C,
                  CN_diff = CN_diff$CN,
                  H_diff = H_diff$H,
                  HC_diff = HC_diff$HC,
                  TotalRespiration = df, df1, df2,
           loss39to52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss39)),
           TotalLossT52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss)),
           #TotalLossT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(loss)),
           TotalLossT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(loss)),
           # = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(GCArea_Dieldrin) ) , 
           #PeakareaT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(GCArea_Dieldrin)),
          #DieldrinT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(Dieldrin)), 
           #DieldrinT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(Dieldrin)),
           DieldrinT52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(Dieldrin)))
p1 <- ggcorrplot::ggcorrplot(cor(df %>% dplyr::select(-Treatment,-RespCumT48, -RespCumT46, -RespCumT44)), type = 'lower')


p2 <- df %>% ggpubr::ggscatter(y = "TotalRespiration", x = "CN",color = "Treatment", palette = "simpsons") + stat_cor(method = "spearman",aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")))
ggarrange(p1)
```

Accumulated respiration is correlated to total dieldrin loss. The higher the microbial respiration, the less dieldrin has dissipated. This was most pronounced with the respiration after 4-8 weeks, which correlated most strongly with the total dieldrin loss after 52 weeks (12 months). 
  
```{r corplot, fig.cap="Correlations of total respiration (µg CO~2~-C g^-1^ soil).", echo = FALSE, warning = FALSE, cache=TRUE, include=TRUE, fig.width=8, fig.asp=1, include = FALSE}
#Calculate the sum of CO2 produced per g of soil

# Total respiration, T0-T16 and T42-T52 combined
df1 <- data_part2.2  %>%  
  select(Samples, Week, µgCO2.Cgsoilday)  %>% 
  tidyr::spread(Week, µgCO2.Cgsoilday) %>% 
  column_to_rownames("Samples")
df1 <-  df1 %>% 
  dplyr::rename(RespT02 = T02) %>% 
  dplyr::rename(RespT04 = T04) %>% 
  dplyr::rename(RespT06 = T06) %>% 
  dplyr::rename(RespT08 = T08) %>% 
  dplyr::rename(RespT10 = T10) %>% 
  dplyr::rename(RespT12 = T12) %>% 
  dplyr::rename(RespT14 = T14) %>% 
  dplyr::rename(RespT16 = T16) %>% 
  dplyr::rename(RespT42 = T42) %>% 
  dplyr::rename(RespT44 = T44) %>% 
  dplyr::rename(RespT46 = T46) %>% 
  dplyr::rename(RespT48 = T48) %>% 
  dplyr::rename(RespT52 = T52)

#Create a df to compare the sum of CO2 produced with other variables
df <- data.frame(Treatment = data_part1[c(1:44),]$Treatment, 
           df1, 
           loss39to52 = as_vector(data_noref %>% 
                                    dplyr::filter(Week == "T52") %>% 
                                    dplyr::select(loss39)),
           TotalLossT52 = as_vector(data_noref %>% 
                                      dplyr::filter(Week == "T52") %>% 
                                      dplyr::select(loss)),
           #TotalLossT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(loss)),
           TotalLossT39 = as_vector(data_noref %>% 
                                      dplyr::filter(Week == "T39") %>% 
                                      dplyr::select(loss)),
           # = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(GCArea_Dieldrin) ) , 
           #PeakareaT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(GCArea_Dieldrin)),
          #DieldrinT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(Dieldrin)), 
           #DieldrinT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(Dieldrin)),
          DieldrinT0 = as_vector(data_noref %>% dplyr::filter(Week == "T0") %>% 
                                   dplyr::select(Dieldrin)),
           DieldrinT52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% 
                                     dplyr::select(Dieldrin)))

#p.mat <- cor_pmat(df %>% dplyr::select(-Treatment))
p1 <- ggcorrplot::ggcorrplot(cor(df %>% dplyr::select(-Treatment)),
  type = "lower")
p1
```

<br/>  


# Part A, analysis of T0－T39
## Dieldrin loss
```{r dlossfig6, echo=FALSE, fig.width=10, fig.asp=1.2, include=TRUE, fig.cap="Residues loss in percent. Error bars show the standard error of the mean of four replicates. Letters show differences of the mean after multiple comparison tests (Fisher's least significant difference, holm correct *p* value)." }

library(ggpubr)
library(agricolae)

#Loss plot for week 39
df <- data_noref %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" ) %>%  # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
  filter(Week == "T39" )
df$Treatment <- factor(df$Treatment)
kr.test <- with(df, agricolae::kruskal(loss,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(df$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)

p1 <- data_noref %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" ) %>%  # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
  filter(Week == "T39" ) %>% 
  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%)") + 
  ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 12.5,label.x = 2) + 
  geom_hline(yintercept = 0, linetype = 2)  + 
  annotate("text", x = groups1$Treatment, y=c(11,11,11,11,11,11,11,11,11,11,11), label = label) + 
  ggtitle("Dieldrin loss from T0 to T39")
#+ ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "Control", hide.ns = TRUE)



p2 <- data_noref %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" ) %>%  # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
  filter(Week == "T39" ) %>% 
  ggpubr::ggboxplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", facet.by = "Week", add = c("jitter"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%)") + 
  #ggpubr::rotate_x_text(angle = 45) + 
  ggpubr::stat_compare_means(method = "kruskal", label.y = 12.5,label.x = 2) + 
  geom_hline(yintercept = 0, linetype = 2)  + 
  annotate("text", x = groups1$Treatment, y=c(11,11,11,11,11,11,11,11,11,11,11), label = label) + 
  ggtitle("Dieldrin loss from T0 to T39") +
  theme(axis.text.x = element_blank() )


p3 <- data_noref %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(SampleName != "#2.run" ) %>%  # removing T16_02 (Control) sample, this was measured without internal standard and varied significantly 
  filter(SampleName != "averageofthree" ) %>%  # removing T16_31 (Sodium formate), this was measured without internal standard and appeared to have failed
  filter(Week == "T39" ) %>% 
  ggpubr::ggboxplot(data =., x = "Week", y = "loss",  palette = "simpsons",  facet.by = "Week", add = c("jitter"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%)", add.params = list(shape = 20, color = "Treatment")) + 
  #ggpubr::rotate_x_text(angle = 45) + 
  geom_hline(yintercept = 0, linetype = 2)  + 
  ggtitle("Dieldrin loss from T0 to T39")+
  theme(axis.text.x = element_blank() )


# Loss plot for week 52
#df <- data_noref %>% 
#  filter(SampleNo != 4 ) %>% 
#  filter(Week == "T52" )
#df$Treatment <- factor(df$Treatment)
#kr.test <- with(df,kruskal(loss,Treatment,group=TRUE, p.adj="holm"))
#levels  <- levels(df$Treatment) %>% as.data.frame()%>% filter(. != "Reference")
#groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
#groups1 <- groups1[match(levels$., groups1$Treatment),]
#label <- as.vector(groups1$groups)

#p2 <- data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T52" ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%)") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 23) + geom_hline(yintercept = 0, linetype = 2)  + annotate("text", x = groups1$Treatment, y=c(20,20,20,20,20,20,20,20,20,20,20), label = label) + ggtitle("Dieldrin loss from T0 to T52")
#+ ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "Control", hide.ns = TRUE)


## loss plot from week 39 using average values of T0 and T16 with dunn test labels
# Do not include - not sure about interpretation
#df1 <- data.frame(T0T16_avg = ((T0$Dieldrin + T16$Dieldrin) / 2), data %>% filter(Week == "T39") %>% select(Dieldrin), data %>% filter(Week == "T52") %>% select(Dieldrin), data %>% filter(Week == "T0") %>% select(Treatment), data %>% filter(Week == "T0") %>% select(SampleNo)  ) %>% rename(T39 = Dieldrin) %>%  rename(T52 = Dieldrin.1) 
#df <-  df1 %>% dplyr::mutate(loss = (T0T16_avg - T39) / T0T16_avg *100 )
#df$Treatment <- factor(df$Treatment)
#kr.test <- with(df,kruskal(loss,Treatment,group=TRUE, p.adj="holm"))
#levels  <- levels(df$Treatment) %>% as.data.frame() 
#groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
#dunntest.df <- rstatix::dunn_test(df, loss ~ Treatment)
#groups1 <- groups1[match(levels$., groups1$Treatment),]
#label <- as.vector(groups1$groups)

#p4 <- df1 %>% dplyr::mutate(loss = (T0T16_avg - T39) / T0T16_avg *100 ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%) T0T16_avg - T39") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 10) + geom_hline(yintercept = 0, linetype = 2) + annotate("text", x = groups1$Treatment, y=c(20,20,20,20,20,20,20,20,20,20,20), label = label)

#pwc <- df %>% mutate(loss = (T0T16_avg - T52) / T0T16_avg *100 ) %>% 
#  dunn_test(loss ~ Treatment, p.adjust.method = "holm") 


## loss plot from week 52 using average values of T0 and T16 with dunn test labels
# Do not include - not sure about interpretation
df1 <- data.frame(T0T16_avg = ((T0$Dieldrin + T16$Dieldrin) / 2), data %>% 
                    filter(Week == "T39") %>% 
                    select(Dieldrin), data %>% 
                    filter(Week == "T52") %>% 
                    select(Dieldrin), data %>% 
                    filter(Week == "T0") %>% 
                    select(Treatment), data %>% 
                    filter(Week == "T0") %>% select(SampleNo)  ) %>% 
  rename(T39 = Dieldrin) %>%  
  rename(T52 = Dieldrin.1) 

df <-  df1 %>% dplyr::mutate(loss = (T0T16_avg - T52) / T0T16_avg *100 )
df$Treatment <- factor(df$Treatment)
kr.test <- with(df,kruskal(loss,Treatment,group=TRUE, p.adj="holm"))
levels  <- levels(df$Treatment) %>% as.data.frame()%>% filter(. != "Reference")
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
#p5 <- df1 %>% mutate(loss = (T0T16_avg - T52) / T0T16_avg *100 ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%) T0T16_avg - T52") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 22) + geom_hline(yintercept = 0, linetype = 2) + annotate("text", x = groups1$Treatment, y=c(20,20,20,20,20,20,20,20,20,20,20), label = label)+ ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "Control", hide.ns = TRUE)

ggarrange(p1, ggarrange(p2,p3, common.legend = TRUE), ncol = 1)
```
  
- Dieldrin concentrations of the treatments using poultry litter and hydrogen peroxide were slightly higher after 9 months (T39) resulting in negative loss. This could be due to (1) a change in solubility or extractability of dieldrin or (2) or due to general variability and therefore due to random chance.  However, multiple comparisons using Fisher’s least significant difference (holm correct p value) indicated that these differences are unlikely due to random chance. 
- Soils treated with biochar showed greatest mean dieldrin dissipation, followed by the no-treatment-control. 
  
## Lineplots of respiration over time
```{r lineplotCO2fig7, fig.width=8, fig.asp=1,  message=FALSE, echo = FALSE, cache=FALSE, warning = FALSE, fig.cap="Respiration  (µg CO~2~-C g^-1^ soil) across time. Error bars show the standard error of the mean of four replicates."}
#p1 <- dataCO2  %>% ggpubr::ggline(data = ., x = "Week_int", y = "µgCO2.Cgsoilday", ylab = "µgCO2.Cgsoilday", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

p2 <- dataCO2 %>% filter(Week %in% c("T02","T04","T06","T08","T10","T12","T14", "T16")) %>% ggpubr::ggline(data = ., x = "Week_int", y = "µgCO2.Cgsoil", ylab = "Respiration (µg CO2-C/g soil)", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

p3 <- data_part1  %>% filter(Week %in% c("T02","T04","T06","T08","T10","T12","T14", "T16"))  %>% ggpubr::ggline(data = ., x = "Week_int", y = "µgCO2gsoilcum", ylab = "Respiration accumulated (µg CO2-C/g soil)", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")


pdf(NULL)
g1 <- ggpubr::ggarrange(p2,p3, nrow = 2, ncol=1, common.legend = TRUE)
x = dev.off()
g1

```
  
- The treatments clearly affected microbial respiration.  
- The heat treatment (3 x autoclaved at 135˚, dry) initially killed microbial organisms but the community recovered and gradually metabolised the heat-released carbon sources and was the treatment with the second highest total respiration after 16 weeks. 


<br/>

## Scatter plot of respiration to dieldrin loss (%)
```{r scatterplotfig8, fig.cap="Scatterplot of total dieldrin loss (%) and total microbial respiration of the first 16 weeks (µg CO~2~-C g^-1^ soil).", echo = FALSE, warning = FALSE, cache=FALSE, fig.width=9, fig.asp=1}
# Calculate the sum of CO2 produced per g of soil and create a df for plotting

df <- data_part1  %>%  select(Samples, Week, µgCO2.Cgsoil) %>% tidyr::spread(Week, µgCO2.Cgsoil) %>% column_to_rownames("Samples") %>% rowSums()

df1 <- data_part1  %>%  select(Samples, Week, µgCO2gsoilcum)  %>% tidyr::spread(Week, µgCO2gsoilcum) %>% column_to_rownames("Samples")

df1 <-  df1 %>% 
  dplyr::rename(RespCumT02 = T02) %>% 
  dplyr::rename(RespCumT04 = T04) %>% 
  dplyr::rename(RespCumT06 = T06) %>% 
  dplyr::rename(RespCumT08 = T08) %>% 
  dplyr::rename(RespCumT10 = T10) %>% 
  dplyr::rename(RespCumT12 = T12) %>% 
  dplyr::rename(RespCumT14 = T14) %>% 
  dplyr::rename(RespCumT16 = T16) 

# Create a df to compare the sum of CO2 produced with other variables
df <- data.frame(Treatment = data_part1[c(1:44),]$Treatment, 
           TotalRespiration = df, 
           df1,
           loss39to52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss39)),
           TotalLossT52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss)),
           TotalLossT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(loss)),
           TotalLossT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(loss)),
           PeakareaT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(GCArea_Dieldrin) ) , 
           PeakareaT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(GCArea_Dieldrin)),
           DieldrinT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(Dieldrin)), 
           DieldrinT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(Dieldrin)) )

p1 <- ggscatter(data = df, x= "TotalRespiration", y = "TotalLossT52", color = "Treatment", palette = "simpsons", ylab = c("Total dieldrin loss after 52 weeks (%)"), xlab = ("Total microbial respiration (µg CO2-C / g soil)"))+ stat_cor(method = "spearman",
   aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))
)
p2 <- ggscatter(data = df, x= "TotalRespiration", y = "TotalLossT39", color = "Treatment", palette = "simpsons",ylab = c("Total dieldrin loss after 39 weeks (%)"), xlab = ("Total microbial respiration (µg CO2-C / g soil)")) + stat_cor(method = "spearman",
   aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))
)

p3 <- ggscatter(data = df, x= "RespCumT06", y = "TotalLossT52", color = "Treatment", palette = "simpsons", ylab = c("Total dieldrin loss after 52 weeks (%)"))+ stat_cor(method = "spearman",
   aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))
)
p4 <- ggscatter(data = df, x= "RespCumT06", y = "TotalLossT39", color = "Treatment", palette = "simpsons",ylab = c("Total dieldrin loss after 39 weeks (%)")) + stat_cor(method = "spearman",
   aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))
)

ggarrange(p2, p1, p4, p3, common.legend = TRUE)

```

Respiration was calculated as the sum of the first 16 weeks of incubation (µg CO~2~-C g^-1^ soil). Hence the microbial respiration was recorded for the first 4 months of incubation only. 
  
- There was a negative relationship of total respiration and dieldrin loss (%). Dieldrin dissipated less in samples were microorganisms respired more carbon.   
- This may be another hint that efficiency of carbon use may be linked to dieldrin degradation. Availability of soluble carbon appears to inhibit dieldrin metabolism.  
- This relationship was stronger with total dieldrin losses after 12 months (which included the 3 months after mixing the soil).  
- Perhaps the availability of soluble carbon primed a microbial community that favored fast growing r-strategists and therefore inhibited metabolism of stable carbon sources (with which dieldrin can be associated), even after soil was broken up. 



<br/>


```{r T0T16avg, echo=FALSE, fig.width=8, fig.asp=0.6,  message=FALSE, echo = FALSE, cache=TRUE, warning = FALSE, include=FALSE, fig.cap="Boxplots of dieldrin concentrations by treatment/week. Average values for T0 and T16 are shown."}

df <- data.frame(T0T16_avg = ((T0$Dieldrin + T16$Dieldrin) / 2), data %>% filter(Week == "T39") %>% select(Dieldrin), data %>% filter(Week == "T52") %>% select(Dieldrin), data %>% filter(Week == "T0") %>% select(Treatment), data %>% filter(Week == "T0") %>% select(SampleNo)  ) %>% rename(T39 = Dieldrin) %>%  rename(T52 = Dieldrin.1) 


mod <- lm(value ~ name, data = df %>% pivot_longer(cols = c("T0T16_avg", "T39", "T52")))
#summary(mod)

ggboxplot( data = df %>% pivot_longer(cols = c("T0T16_avg", "T39", "T52")), x = "Treatment", y = "value", fill = "name", palette = "simpsons", ylab = "Dieldrin (µg/g)") + rotate_x_text(angle = 45) + labs(fill = "Week")

```


<br/>  
```{r line, include = FALSE, echo=FALSE, fig.width=8, fig.asp=1,  message=FALSE, cache=TRUE, warning = FALSE, fig.cap="Residues remaining since T0 in percent for two sets of treatments including the control (a,b). Error bars show the standard error of the mean of four replicates. Dieldrin concentrations (µg/g) over time."}

l1 <- data_noref  %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(Week != "T52" ) %>% filter(Treatment %in% c("Control", "Heat", "Lime", "Biochar", "PoultryLitter","H2O2")) %>% ggpubr::ggline(data =., x = "Week_int", y = "T0_Diff", ylab = "Residue remaining since T0 (%)", add = c("mean_se"), color = "Treatment", palette = "simpsons",xlab = FALSE)  + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal") + ggpubr::rotate_x_text(angle = 45) 

s1 <- data_noref  %>% 
  #filter(SampleName != "t0_4.run" ) %>% 
  filter(Week != "T52" ) %>% filter(Treatment %in% c("Control", "Heat", "Lime", "Biochar", "PoultryLitter","H2O2")) %>% ggpubr::ggscatter(data=., x = "Week_int", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = c("reg.line"), color = "Treatment", palette = "simpsons",xlab = FALSE ) + ggpubr::rotate_x_text(angle = 45)

l2 <-   data_noref  %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(Week != "T52" ) %>% filter(Treatment %in% c("Control", "CitricAcid", "Inositol","SodiumFormate", "SodiumAcetate","FumaricAcid")) %>% ggpubr::ggline(data =., x = "Week_int", y = "T0_Diff", ylab = c("Residue remaining since T0 (%)"), add = c("mean_se"), color = "Treatment", palette = "simpsons",xlab = FALSE) +  ggpubr::rotate_x_text(angle = 45)+ ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal") 

s2 <-  data_noref  %>% 
  #filter(SampleName != "t0_4.run" ) %>% 
  filter(Week != "T52" )%>% filter(Treatment %in% c("Control", "CitricAcid", "Inositol","SodiumFormate", "SodiumAcetate","FumaricAcid")) %>% ggpubr::ggscatter(data=., x = "Week_int", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = c("reg.line"), color = "Treatment", palette = "simpsons",xlab = FALSE) + ggpubr::rotate_x_text(angle = 45)


pdf(NULL)
x = dev.off()
ggpubr::ggarrange(ncol =1, nrow=2, ggarrange(l1, s1, ncol = 2, nrow =1, common.legend = TRUE), ggarrange(l2, s2, ncol =2, nrow =1, common.legend = TRUE), labels = "auto" ) 

```


<br/>
```{r line23952, include = FALSE, echo=FALSE, fig.width=8, fig.asp=1,  message=FALSE, cache=TRUE, warning = FALSE, fig.cap="Residues remaining since T39 (9 month) in percent for two sets of treatments including the control (a,b). Error bars show the standard error of the mean of four replicates. Dieldrin concentrations (µg/g) over time."}
l1 <- data_noref  %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(Week %in% c("T39", "T52" )) %>% 
  filter(Treatment %in% c("Control", "Heat", "Lime", "Biochar", "PoultryLitter","H2O2")) %>% 
  ggpubr::ggline(data =., x = "Week_int", y = "T39_Diff", ylab = c("Residue remaining since T39 (%)"), add = c("mean_se"), color = "Treatment", palette = "simpsons",xlab = FALSE)  + 
  ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal") + ggpubr::rotate_x_text(angle = 45) 

s1 <- data_noref  %>% 
  #filter(SampleName != "t0_4.run" ) %>% 
  filter(Week %in% c("T39", "T52" )) %>% 
  filter(Treatment %in% c("Control", "Heat", "Lime", "Biochar", "PoultryLitter","H2O2")) %>% 
  ggpubr::ggscatter(data=., x = "Week_int", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = c("reg.line"), color = "Treatment", palette = "simpsons",xlab = FALSE ) + 
  ggpubr::rotate_x_text(angle = 45)

l2 <-   data_noref  %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(Week %in% c("T39", "T52" )) %>% 
  filter(Treatment %in% c("Control", "CitricAcid", "Inositol","SodiumFormate", "SodiumAcetate","FumaricAcid")) %>% ggpubr::ggline(data =., x = "Week_int", y = "T39_Diff", ylab = c("Residue remaining since T39 (%)"),  add = c("mean_se"), color = "Treatment", palette = "simpsons",xlab = FALSE) +  ggpubr::rotate_x_text(angle = 45)+ ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal") 

s2 <-  data_noref  %>% 
  #filter(SampleName != "t0_4.run" ) %>% 
  filter(Week %in% c("T39", "T52" ))%>% filter(Treatment %in% c("Control", "CitricAcid", "Inositol","SodiumFormate", "SodiumAcetate","FumaricAcid")) %>% ggpubr::ggscatter(data=., x = "Week_int", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = c("reg.line"), color = "Treatment", palette = "simpsons",xlab = FALSE) + 
  ggpubr::rotate_x_text(angle = 45)

pdf(NULL)
x = dev.off()
ggpubr::ggarrange(ncol =1, nrow=2, ggarrange(l1, s1, ncol = 2, nrow =1, common.legend = TRUE), ggarrange(l2, s2, ncol =2, nrow =1, common.legend = TRUE), labels = "auto" ) 

```
<br/>


# Part B  analysis of T39－T52
## Dieldrin loss
```{r dlossfig9, echo=FALSE, fig.width=6, fig.asp=1, include=TRUE, fig.cap="Residues loss in percent. At T39 the soil was ploughed inside the jars. Two timelines were therefore assessed separately (T0−T39 and T39−T52). Error bars show the standard error of the mean of four replicates. Letters show differences of the mean after multiple comparison tests (Fisher's least significant difference, holm correct *p* value)."}
## loss plot from week 52 since week 39 

library(ggpubr)
library(agricolae)
df <-  data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T52" )
df$Treatment <- factor(df$Treatment)
kr.test <- with(df,kruskal(loss39,Treatment,group=TRUE, p.adj="holm"))
levels  <- levels(df$Treatment) %>% as.data.frame()%>% filter(. != "Reference")
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)

p3 <- data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T52" ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss39",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%) T39 - T52") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 19, label.x = 2) + geom_hline(yintercept = 0, linetype = 2) + annotate("text", x = groups1$Treatment, y=c(17,17,17,17,17,17,17,17,17,17,17), label = label) + ggtitle("Dieldrin loss from T39 to T52")
ggarrange(p3, ncol = 1)

```

## Lineplots of respiration over time
```{r lineplotCO2fig10, fig.width=8, fig.asp=1.5,  message=FALSE, echo = FALSE, cache=FALSE, warning = FALSE, fig.cap="Respiration  (µg CO~2~-C g^-1^ soil) across time. Error bars show the standard error of the mean of four replicates."}
#p1 <- dataCO2  %>% ggpubr::ggline(data = ., x = "Week_int", y = "µgCO2.Cgsoilday", ylab = "µgCO2.Cgsoilday", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

p2 <- dataCO2 %>% filter(Week %in% c("T42", "T44", "T46", "T48", "T52")) %>% ggpubr::ggline(data = ., x = "Week_int", y = "µgCO2.Cgsoilday", ylab = "Respiration (µg CO2-C/g soil)", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

p3 <- data_part2  %>% filter(Week %in%c("T42", "T44", "T46", "T48", "T52"))  %>% ggpubr::ggline(data = ., x = "Week_int", y = "µgCO2gsoilcum", ylab = "Respiration accumulated (µg CO2-C/g soil)", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

p4 <- data_part2  %>% filter(Week %in%c("T42", "T44", "T46", "T48", "T52"))  %>% ggpubr::ggscatter(data = ., x = "Week_int", y = "µgCO2gsoilcum", ylab = "Respiration accumulated (µg CO2-C/g soil)", add = c("reg.line"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

pdf(NULL)
g1 <- ggpubr::ggarrange(p2,p3, p4, nrow = 3, ncol=1, common.legend = TRUE)
x = dev.off()
g1


#pdf(NULL)
#g1 <- ggpubr::ggarrange(p2,p3, nrow = 2, ncol=1, common.legend = TRUE)
#x = dev.off()
#g1

```

<br/>

## Scatter plot of respiration to dieldrin loss (%)
```{r scatterplotfig10, fig.cap="Scatterplot of total dieldrin loss (%) and total microbial respiration (µg CO~2~-C g^-1^ soil) for weeks 42 to 52.", echo = FALSE, warning = FALSE, cache=FALSE, fig.width=11, fig.asp=1}
#Calculate the sum of CO2 produced per g of soil and create a df for plotting
df <- dataCO2 %>% filter(Week %in% c("T42","T44","T46", "T48","T52")) %>%  select(Samples, Week, µgCO2.Cgsoil) %>% tidyr::spread(Week, µgCO2.Cgsoil) %>% column_to_rownames("Samples") %>% rowSums()

#df1 <- data_part1  %>%  select(Samples, Week, µgCO2gsoilcum)  %>% tidyr::spread(Week, µgCO2gsoilcum) %>% column_to_rownames("Samples")

#Create a df to compare the sum of CO2 produced with other variables
df <- data.frame(Treatment = data_part1[c(1:44),]$Treatment, 
           TotalRespiration = df, 
           loss39to52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss39)),
           TotalLossT52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss)),
           TotalLossT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(loss)),
           TotalLossT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(loss)),
           PeakareaT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(GCArea_Dieldrin) ) , 
           PeakareaT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(GCArea_Dieldrin)),
          DieldrinT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(Dieldrin)), 
           DieldrinT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(Dieldrin)) )


p1 <- ggscatter(data = df, x= "TotalRespiration", y = "loss39to52", color = "Treatment", palette = "simpsons",ylab = c("Dieldrin loss in weeks 39 to 52 (%)"), xlab = ("Total microbial respiration (µg CO2-C / g soil)")) 

p2 <- ggscatter(data = df %>% filter(Treatment %in% c("Control","Lime","Biochar","PoultryLitter", "Heat", "H2O2","FumaricAcid")), x= "TotalRespiration", y = "loss39to52", color = "Treatment", palette = "simpsons",ylab = c("Dieldrin loss in weeks 39 to 52 (%)"), xlab = ("Total microbial respiration (µg CO2-C / g soil)"))  + stat_cor(method = "spearman", aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")) )

p3 <- ggscatter(data = df %>% filter(Treatment %in% c("CitricAcid","Inositol","SodiumFormate","SodiumAcetate")), x= "TotalRespiration", y = "loss39to52", color = "Treatment", palette = "simpsons", ylab = c("Dieldrin loss in weeks 39 to 52 (%)"), xlab = ("Total microbial respiration (µg CO2-C / g soil)"))  + stat_cor(method = "spearman", aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")) )

ggarrange(p1, ggarrange(p2, p3, nrow = 1), nrow = 2)

```


```{r scatterplotfig12, fig.cap="Scatterplot of total dieldrin loss (%) and total microbial respiration combined for weeks 1 - 16 and 42 to 52. Only treatments Control, Poultry Litter, Lime, Biochar, Heat and H202 are shown", echo = FALSE, warning = FALSE, cache=FALSE, fig.width=7, fig.asp=0.75}
# Calculate the sum of CO2 produced per g of soil and create a df for plotting

# Create a df to compare the sum of CO2 produced with other variables
df <- data.frame(Treatment = data_part1[c(1:44),]$Treatment, 
           TotalRespiration = data_part2.2 %>% filter(Week == "T52") %>% select(µgCO2gsoilcum) , 
           loss39to52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss39)),
           TotalLossT52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss)),
           TotalLossT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(loss)),
           TotalLossT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(loss)),
           PeakareaT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(GCArea_Dieldrin) ) , 
           PeakareaT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(GCArea_Dieldrin)),
          DieldrinT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(Dieldrin)), 
           DieldrinT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(Dieldrin)) )


p1 <- ggscatter(data = df %>% filter(Treatment %in% c("Control","Lime","Biochar","PoultryLitter", "Heat", "H2O2")), x= "µgCO2gsoilcum", y = "TotalLossT52", color = "Treatment", palette = "simpsons",ylab = c("Dieldrin loss (%) after 52 weeks"), xlab = ("Total microbial respiration (µg CO2-C / g soil)"))  + stat_cor(method = "spearman", aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~")) )


p1
```

<br/>

```{r ordinarymodels, message=FALSE, echo = TRUE, warning = FALSE, include=FALSE}

intercept <- 1
df <- data_noref %>% filter(Week != "T0") #%>% filter(SampleNo != 4 )
mod2 <- lm(I((T0_Diff) - intercept) ~  Treatment, data = df)
summary(mod2)
car::Anova(mod2, type = 3)

intercept <- data_noref %>% 
  #filter(SampleName != "t0_4.run" ) %>% 
  summarise(meanD = mean(Dieldrin))
intercept <- intercept$meanD
df <- data #%>% filter(SampleName != "t0_4.run" )
mod3 <- lm(I(Dieldrin - intercept) ~ Treatment, data = df)
summary(mod3)
car::Anova(mod2, type = 3)

```

# Part C  analysis of T0－T52
```{r dlosfig13, echo=FALSE, fig.width=6, fig.asp=1, include=TRUE, fig.cap="Residues loss in percent. Error bars show the standard error of the mean of four replicates. Letters show differences of the mean after multiple comparison tests (Fisher's least significant difference, holm correct *p* value)."}

library(ggpubr)
library(agricolae)
df <-  data_noref %>% 
  #filter(SampleNo != 4 ) %>% 
  filter(Week == "T52" )
df$Treatment <- factor(df$Treatment)
kr.test <- with(df,kruskal(loss,Treatment,group=TRUE, p.adj="holm"))
levels  <- levels(df$Treatment) %>% as.data.frame()%>% filter(. != "Reference")
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T52" ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%) T0 - T52") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 20.5, label.x = 2) + geom_hline(yintercept = 0, linetype = 2) + annotate("text", x = groups1$Treatment, y=c(20,20,20,20,20,20,20,20,20,20,20), label = label) + ggtitle("Dieldrin loss from T0 to T52")

```

# Other analyses
## nMDS of GC/ECD peak areas   
Peaks areas from analysis soil extracts (hexane:acetone 1:1) were normalised to an internal standard (DDD)
```{r phyloseqnmdsfig14, message=FALSE, echo = FALSE, warning = FALSE, results=FALSE, fig.cap="nMDS of peak areas of soil extracts (hexane:acetone 1:1)."}
theme_set(theme_bw())  
xaxis = c(-0.4, 0.4)

ratio.df <- read_csv("~/Documents/Study/LaTrobe/Research/phD/Milestone3/R_M3/Peak_analysis/ratio_df.csv") %>% column_to_rownames("id") 

metadata <- readr::read_csv("~/Documents/Study/LaTrobe/Research/phD/Milestone3/M3_IncubationStudy/data.csv") 
metadata <- metadata %>% filter(id != 'NA') %>% column_to_rownames("id")

substances <- readr::read_csv("~/Documents/Study/LaTrobe/Research/phD/Milestone3/R_M3/Peak_analysis/substances_taxa.csv") %>% column_to_rownames("#Species") 

physeq <- phyloseq::phyloseq(
   phyloseq::otu_table(ratio.df, taxa_are_rows = F), 
   phyloseq::tax_table(substances %>% as.matrix()),
   phyloseq::sample_data(metadata) )

physeq_log <- microbiome::transform(physeq, "log10")
physeq_rel <- microbiome::transform(physeq, "compositional")
physeq_clr <- microbiome::transform(physeq, "clr")


physeq_log = phyloseq::filter_taxa(physeq_log, function(x) sum(x > 0) > (0.50*length(x)), TRUE)
ord_nmds <- phyloseq::ordinate(physeq_log, "NMDS", "bray")

nmds1 <- phyloseq::plot_ordination(physeq_log, ord_nmds , color = "Treatment", shape = "Week") + ggtitle("nMDS of hydrophobic substances from soil extracts (hexane:acetone), bray") + theme(plot.title = element_text(size = 8)) + theme(plot.title = element_text(size = 8)) + theme( panel.grid.major = element_blank(), panel.grid.minor = element_blank() ) + xlim(xaxis) + geom_hline(yintercept=0, linetype="dashed", color = "gray") + geom_vline(xintercept=0, linetype="dashed", color = "gray")

#nmds1  <- nmds1  +  geom_text_repel(label = nmds1$data$days)
nmds1 <- nmds1 + stat_ellipse(aes(group = Week), type = "t", linetype = 2)
#nmds1 <- nmds1 + geom_polygon(aes(alpha = 0.6, fill = Rhizosphere,group = TreatmentID), stat = "identity") + guides(alpha = F)
nmds1
```

The biochar resulted in significantly different composition of hydrophobic substances extracted from the soil. This composition has changed after the start of T0 but remained different to all other treatments.  

<br/> 
  
## Table Summary 
https://www.datanovia.com/en/lessons/repeated-measures-anova-in-r/
```{r rmanova, echo=FALSE, message=FALSE, cache=TRUE, warning = FALSE, include=TRUE}
# Normality
library(rstatix)
#data %>% filter(SampleName != "t0_4.run" ) %>% 
#  group_by(Week) %>%
#   rstatix::shapiro_test(Dieldrin)

# outliers
#data  %>%
#  group_by(Week) %>%
#  rstatix::identify_outliers(Dieldrin) %>% select(Week,Treatment, Dieldrin, is.outlier, is.extreme)



#Transform dieldrin values to improve distribution in order to meet normality assumption
#remove 1 extreme outlier sample (Control, 1.33µg/g dieldrin)

kableExtra::kable(data %>% 
                    #filter(SampleName != "t0_4.run" ) %>%
                    filter(SampleName != "#2.run" ) %>%
  group_by(Week, Treatment) %>%
  get_summary_stats(Dieldrin, type = "mean_se")) %>% kableExtra::kable_styling(full_width = F, position = "left",bootstrap_options = c( "condensed"), font_size = 11 )
```

```{r rmanova2, echo=FALSE, message=FALSE, echo = TRUE, cache=TRUE, warning = FALSE, include=FALSE}
data_fltrd %>%
  group_by(Week) %>%
   rstatix::shapiro_test(Dieldrin_trans) 

data_fltrd %>%
  group_by(Week) %>%
   rstatix::shapiro_test(Dieldrin)

#Go with log transform for now
```

```{r rmanova3, echo=TRUE, message=FALSE, echo = TRUE, cache=TRUE, warning = FALSE, include=FALSE}
library(rstatix)

res.aov <- anova_test(data = data_fltrd, dv = Dieldrin_trans, between = c(Week, Treatment))

rstatix::get_anova_table(res.aov)

pwc <- data_fltrd %>%
  pairwise_t_test(
    Dieldrin_trans ~ Week, paired = FALSE,
    p.adjust.method = "bonferroni"
    )

bxp <- ggboxplot(data_fltrd, x = "Week", y = "Dieldrin_trans", add = "point")

pwc <- pwc %>% add_xy_position(x = "Week")
bxp <- bxp + 
  stat_pvalue_manual(pwc) +
  labs(
    subtitle = get_test_label(res.aov, detailed = TRUE),
    caption = get_pwc_label(pwc)
  )
bxp
```

```{r rmanova4, echo=TRUE, message=FALSE, echo = TRUE, cache=TRUE, warning = FALSE, include=FALSE}
data_fltrd %>%
  group_by(Treatment, Week) %>%
  get_summary_stats(Dieldrin_trans, type = "mean_sd")

data_fltrd %>%
  group_by(Treatment, Week) %>%
  identify_outliers(Dieldrin) %>% dplyr::select(Week, Treatment, Dieldrin, is.outlier, is.extreme)

ggqqplot(data_fltrd, "Dieldrin_trans", ggtheme = theme_bw()) +
  facet_grid(Week ~ Treatment, labeller = "label_both")
```


```{r rmanova5, echo=TRUE, message=FALSE, eval= FALSE, cache=TRUE, warning = FALSE, include = FALSE}
## A repeated measures ANOVA (this is not valid as I used replicates as individuals)
#There were no individual soils that were treated differently but wanted to see what happens if we assume that each replicate was the same individual

data_sel <- data %>% dplyr::select(Replicate, Treatment, Week, Dieldrin) %>% as_tibble()
anova_test(  data = data_sel, dv = Dieldrin, wid = Replicate,
  within = c(Treatment, Week) )

```


```{r lme, include=FALSE, eval=FALSE, fig.width=10, fig.asp= 1, message=FALSE, echo = TRUE, warning = FALSE, include=FALSE}
library(lme4)
library(lmerTest)
library(car)
library(rafalib)
library(visreg)
library(sjPlot)
library(sciplot)
library(nlme)
library(MASS)
library(ggpubr)
theme_set(theme_bw())


M <- gls(log(Dieldrin) ~ Treatment, data = data_fltrd)
M0 <- lme(log(Dieldrin)  ~ Treatment,  random =~ 1 | SampleNo, data = data_fltrd)
M1 <- lme(log(Dieldrin)  ~ Treatment,  random =~ 1 | Week_int/SampleNo, data = data_fltrd)
M2 <- lme(log(Dieldrin)  ~  Treatment,  random =~ 1 | SampleNo/Week_int, data = data_fltrd)
M3 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | SampleNo/InjectionDate, data = data_fltrd)
M4 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | InjectionDate, data = data_fltrd)
M5 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | InjectionDate/SampleNo, data = data_fltrd)
M6 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | Week_int/InjectionDate, data = data_fltrd)
M7 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | Week_int, data = data_fltrd)
anova(M, M0, M1, M2, M3, M4, M5, M6, M7)

M <- gls(log1p(Dieldrin) ~ Treatment + Week, data = data)
M0 <- lme(log1p(Dieldrin)  ~ Treatment + Week,  random =~ 1 | SampleNo, data = data)
M1 <- lme(log1p(Dieldrin)  ~ Treatment + Week,  random =~  1 | InjectionDate, data = data)
#M2 <- lme(log1p(Dieldrin_cor)  ~ Treatment + Week,  random =~  1 | Week_int, data = data)
anova(M, M0, M1)


M1 <-  lme(log(Dieldrin)  ~ Treatment,  random =~  1 | Week_int/InjectionDate, data = data_fltrd)

E <- resid(M1, type = 'normalized') 
shapiro.test(E)
E <- data.frame(E = E)

Ehist <- ggplot(E, aes(x=(E))) +  geom_histogram(color="black", fill="black") + ggtitle("Residuals Histogram")

F0 <- fitted(M1)
df <- data.frame(F0 = F0, E = E, Treatment = data_fltrd$Treatment, Week_int = data_fltrd$Week_int, Dieldrin = data_fltrd$Dieldrin_trans) 

residscatter <- ggscatter(data= df, x = "F0", y = "E", xlab = "Fitted values", ylab = "Residuals") + ggtitle("Residuals distribution")

D_scatter <- ggscatter(data= df, x = "Dieldrin", y = "E", xlab = "Dieldrin_trans", ylab = "Residuals", add = ("reg.line"))

trt_bxp <- ggboxplot(data= df, x = "Treatment", y = "E", xlab = "Treatment fitted values", ylab = "Residuals", add = ("jitter"))+ rotate_x_text(angle = 45)

Week_scatter <- ggscatter(data= df, x = "Week_int", y = "E", xlab = "Week_int", ylab = "Residuals", add = ("reg.line"))

ggarrange(Ehist, residscatter, D_scatter, Week_scatter, trt_bxp, nrow = 3, ncol = 2)
```
  
 
```{r, include=FALSE, eval=FALSE, include = FALSE}
## Auto-correlation plot
acf(E)
```

<br/> 
```{r, include=FALSE, eval=FALSE,message=FALSE, echo = FALSE, warning = FALSE, include = FALSE}
summary(M1)
```

# References