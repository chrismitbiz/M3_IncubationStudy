---
title: "Soil Incubations of Soil Contaminated with Legacy Pesticides"
author: "CK"
date: "15/06/2020"
output: 
 bookdown::html_document2:
   toc: yes
   fig_caption: yes
   number_sections: false
editor_options: 
  chunk_output_type: console
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file,
  encoding=encoding,
  output_file=file.path(dirname(input_file), out_dir, 'index.html'))})
  
---

```{r raw_peakdata_standards_dieldrin, message=FALSE, echo = FALSE, warning = FALSE}
library(reshape2)
library(lubridate)
library(tidyverse)

Sample_Peaks <- read.csv("peak_area_samples.csv", header = TRUE, row.names=NULL)
Sample_Peaks1 <- Sample_Peaks %>%  filter(!is.na(GCArea_DDD))
Sample_Peaks2 <- Sample_Peaks %>%  filter(is.na(GCArea_DDD))
  
Standards_Peaks <- read.csv("peak_area_standards.csv", header = TRUE, row.names=NULL)
Standards_Peaks_Donly <- read.csv("peak_area_standards_Donly.csv", header = TRUE, row.names=NULL)
#remove outlier
Standards_Peaks <- Standards_Peaks[-39,]

#Skip this step and only use the dieldrin calcs with corrected standards 
# calculate dieldrin concentrations from d/ddd ratios (internal standard) #
#create standard ratios and regression coefficients 
#ratio_df <- Standards_Peaks %>% mutate(InjectionDate = lubridate::dmy(Standards_Peaks$InjectionDate))  %>% mutate("0.47" = D0.47 / DDD0.47)  %>% mutate("0.094" = D0.094 / DDD0.094) %>% mutate("0.0094" = D0.0094 / DDD0.0094) %>% select(InjectionDate,"0.47", "0.094", "0.0094") %>%   reshape2::melt(data = . , measure.vars = c("0.47", "0.094","0.0094"))
#make variable numeric
#mapping <- c("0.47" = 0.47, "0.094" = 0.094, "0.0094" = 0.0094)
#ratio_df$variable <- mapping[ratio_df$variable]

#model regression for each injection date and create table with coefficients
#require(broom)
#intercept_slope <- ratio_df %>%   group_by(InjectionDate) %>%   nest() %>% mutate(model = map(data, ~lm(variable ~ value, data = .) %>%  tidy)) %>%  unnest(model) %>%  select(InjectionDate,estimate, term) %>%  pivot_wider(names_from = term, values_from = estimate) 

# get sample ratios and add the regression results and dieldrin concentrations
# Sample_Peaks1 <- Sample_Peaks1 %>% mutate(InjectionDate = lubridate::dmy(Sample_Peaks1$InjectionDate)) %>%inner_join(intercept_slope, by = c("InjectionDate" = "InjectionDate")) %>% mutate(Splratio = GCArea_Dieldrin / (GCArea_DDD * 0.98)) %>%mutate(Dieldrin = (Splratio * value + `(Intercept)`) * 12) %>% dplyr::select(-value, -`(Intercept)`)


#Do the same again but with ratios corrected for changes in means (standards have changed over time)
#create standard ratios and regression coefficients
ratio_cor_df <- Standards_Peaks %>%
  mutate(InjectionDate = lubridate::dmy(Standards_Peaks$InjectionDate))%>%
  mutate("0.47" = ( ( (DDD0.47 / mean(DDD0.47)) - (D0.47 /  mean(D0.47))+1 )) * (D0.47 / DDD0.47) )  %>%
  mutate("0.094" = ( ( (DDD0.094 / mean(DDD0.094)) - (D0.094 /  mean(D0.094))+1 )) * (D0.094 / DDD0.094) ) %>%
  mutate("0.0094" = ( ( (DDD0.0094 / mean(DDD0.0094)) - (D0.0094 /  mean(D0.0094))+1 )) * (D0.0094 / DDD0.0094) ) %>%
  select(InjectionDate,"0.47", "0.094", "0.0094") %>%
  melt(data = . , measure.vars = c("0.47", "0.094","0.0094"))
#make variable numeric
mapping <- c("0.47" = 0.47, "0.094" = 0.094, "0.0094" = 0.0094)
ratio_cor_df$variable <- mapping[ratio_cor_df$variable]
#model regression for each injection date and create table with coefficients
require(broom)
intercept_slope <- ratio_cor_df %>% 
  group_by(InjectionDate) %>% 
  nest()%>%
  mutate(model = map(data, ~lm(variable ~ value, data = .) %>% 
                       tidy)) %>% 
  unnest(model) %>% 
  select(InjectionDate,estimate, term) %>% 
  pivot_wider(names_from = term, values_from = estimate) 

# get sample ratios and add the regression results and dieldrin concentrations
Sample_Peaks1 <- Sample_Peaks1 %>% 
  mutate(InjectionDate = lubridate::dmy(Sample_Peaks1$InjectionDate))  %>%
  inner_join(intercept_slope, by = c("InjectionDate" = "InjectionDate")) %>% mutate(Splratio = GCArea_Dieldrin / (GCArea_DDD * 0.98)) %>% mutate(Dieldrin = (Splratio * value + `(Intercept)`) * 12) %>% dplyr::select(-value, -`(Intercept)`) %>% dplyr::select(-Splratio)
# 1 ml analysed of 12 ml extracts


# Calculate dieldrin concentrations from those measurements where no internal standard was available #
std_df <- Standards_Peaks_Donly %>%
  mutate(InjectionDate = lubridate::dmy(Standards_Peaks_Donly$InjectionDate))  %>%
  mutate("0.47" = D0.47)  %>%
  mutate("0.094" = D0.094 ) %>%
  mutate("0.0094" = D0.0094) %>%
  select(InjectionDate,"0.47", "0.094", "0.0094") %>%
    reshape2::melt(data = . , measure.vars = c("0.47", "0.094","0.0094"))
#make variable numeric
mapping <- c("0.47" = 0.47, "0.094" = 0.094, "0.0094" = 0.0094)
std_df$variable <- mapping[std_df$variable]
#model regression for each injection date and create table with coefficients
require(broom)
intercept_slope <- std_df %>% 
  group_by(InjectionDate) %>% 
  nest() %>%
  mutate(model = map(data, ~lm(variable ~ value, data = .) %>% 
                       tidy)) %>% 
  unnest(model) %>% 
  select(InjectionDate,estimate, term) %>% 
  pivot_wider(names_from = term, values_from = estimate) 

Sample_Peaks2 <- Sample_Peaks2 %>% 
  mutate(InjectionDate = lubridate::dmy(Sample_Peaks2$InjectionDate))  %>%
  inner_join(intercept_slope, by = c("InjectionDate" = "InjectionDate")) %>% 
  mutate(Dieldrin = (GCArea_Dieldrin * value + `(Intercept)`) * 12) %>% dplyr::select(-value, -`(Intercept)`)
# 1 ml analysed of 12 ml extracts

# Combine Sample_peaks1 and 2 (So dieldrin values from internal standards plus earlier measurments without internal standards)

Sample_Peaks <- rbind(Sample_Peaks1, Sample_Peaks2)

#Final output for graphing
```

# Data overview
```{r dataoverview, echo=FALSE, fig.width=10, fig.asp=0.4, message=FALSE, echo = FALSE, warning = FALSE, cache=TRUE, include=FALSE}
library(hrbrthemes)
library(ggpubr)
library(tidyverse)
library(rstatix)

data <- Sample_Peaks %>% rename(Week = "TWeeks") %>% filter(SampleName != "t0__40_e2c1001")

data$Treatment[data$Treatment == "AutoclavedControl"] <- "Heat"
data$Treatment[data$Treatment == "ref_garretto"] <- "Reference"
data <- data  %>% filter(Project != "M4")
data <- data %>% mutate(Week_int = case_when(Week == "T16" ~ 16,
                              Week == "T39" ~ 39,
                              Week == "T52" ~ 52,
                              Week == "re" ~ 0,
                              TRUE ~0) )
data <- data %>% mutate(Category = case_when(Treatment == "Control" ~ "Control",
                                             Treatment == "Reference" ~ "Reference",
                              TRUE ~ "Treatment") )

data <- data %>% convert_as_factor(SampleID, SampleNo, Replicate)
#order factors
data$Treatment <- factor(data$Treatment, levels=c("Reference","Control", "Lime", "PoultryLitter", "Biochar", 
                                                                "CitricAcid", "Inositol", "SodiumFormate", "SodiumAcetate",
                                                                "FumaricAcid", "Heat","H2O2"))
#data$Category <- factor(data$Category, levels=c("Control","AGamend", "Csubstrate", "Stress"))
data$Week <- factor(data$Week, levels=c("re", "T0","T16", "T39", "T52"))
data  <- data %>% arrange(Week, SampleNo)
data$Dieldrin_trans <- log(data$Dieldrin)

# outliers
#data %>%
#  group_by(Week) %>%
#  rstatix::identify_outliers(Dieldrin) %>% select(Week,Treatment, Dieldrin, is.outlier, is.extreme)
#identified sample 04 (control) as extreme outlier

T0 <- data %>% filter(Week == "T0")
T16 <- data %>% filter(Week == "T16")
T39 <- data %>% filter(Week == "T39")
T52 <- data %>% filter(Week == "T52")

data_noref <- data %>% dplyr::filter(Treatment != "Reference") %>% 
  mutate(T0_Diff = Dieldrin / T0$Dieldrin * 100) %>% 
  mutate(T39_Diff = Dieldrin / T39$Dieldrin * 100) %>% 
  mutate(loss = (T0$Dieldrin - Dieldrin) /  T0$Dieldrin * 100) %>% 
  mutate(loss39 = (T39$Dieldrin - Dieldrin) /  T39$Dieldrin * 100) 

data_fltrd <- data_noref %>% filter(SampleName != "t0_4.run") %>% filter(Treatment != "Reference")

intercept <- mean(T0$Dieldrin[-4])
mod2 <- lm(I((Dieldrin) - intercept) ~  Week, data = data_fltrd)
summary(mod2)
car::Anova(mod2, type = 3)

df <- data_noref %>% filter(Week != "T0")
#shapiro.test(df$T0_Diff)
#mod1 <- lm(log1p(T0_Diff) ~ Week, data = df)
#summary(mod1)
#car::Anova(mod, type = 3)
intercept <- 1
mod2 <- lm(I((T0_Diff) - intercept) ~  Week, data = df)
summary(mod2)
car::Anova(mod2, type = 3)

intercept <- mean(T0$Dieldrin[-4])
mod <- lm(Dieldrin_trans ~  Treatment*Week, data = data_fltrd)
summary(mod)
car::Anova(mod2, type = 3)

# Summary mean and sd
data %>% filter(SampleName != "t0_4.run" ) %>%
  group_by(Week) %>%
  get_summary_stats(Dieldrin, type = "mean_se")
```


```{r dataCO2, message=FALSE, echo = FALSE, warning = FALSE}
library(reshape2)
library(lubridate)
library(tidyverse)
library(hrbrthemes)
library(ggpubr)
library(tidyverse)
library(rstatix)
dataCO2 <- read.csv("dataCO2.csv", header = TRUE, row.names=NULL)
dataCO2 <-dataCO2 %>%  dplyr::mutate_all(type.convert) %>% dplyr::mutate_if(is.factor, as.character) 

dataCO2$Treatment[dataCO2$Treatment == "AutoclavedControl"] <- "Heat"
dataCO2 <- dataCO2 %>% mutate(Week_int = case_when(Week == "T02" ~ 02,
                              Week == "T04" ~ 04,
                              Week == "T06" ~ 06,
                              Week == "T08" ~ 08,
                              Week == "T10" ~ 10,
                              TRUE ~0))
dataCO2 <- dataCO2 %>% convert_as_factor(Samples, Treatment, Replicate, Week, Category)
#order factors
dataCO2$Treatment <- factor(dataCO2$Treatment, levels=c("Control", "Lime", "PoultryLitter", "Biochar", 
                                                                "CitricAcid", "Inositol", "SodiumFormate", "SodiumAcetate",
                                                                "FumaricAcid", "Heat","H2O2"))
CO2cum <- dataCO2  %>% select(Samples, Week, µgCO2.Cgsoil) %>% tidyr::pivot_wider(names_from= c(Week), values_from = µgCO2.Cgsoil) %>% column_to_rownames("Samples") %>% mutate(T04_cum = T02 + T04) %>% mutate(T06_cum = T04_cum + T06) %>% mutate(T08_cum = T06_cum + T08) %>% mutate(T10_cum = T08_cum + T10)  %>% rownames_to_column("Samples") %>% dplyr::select(Samples, T02, T04_cum,T06_cum, T08_cum, T10_cum) %>% pivot_longer(names_to = "Week",  cols = T02:T10_cum) %>% dplyr::mutate_all(type.convert) %>% arrange(Week, Samples)

dataCO2$µgCO2gsoilcum <- CO2cum$value


```

```{r boxplots1, fig.width=10, fig.asp=0.8, message=FALSE, echo = FALSE, warning = FALSE, cache=TRUE, fig.cap="Boxplots of dieldrin concentrations and dieldrin concentrations relative to start of experiment (T0), including histograms."}

p1.1 <- data_noref %>% filter(Week != "T0") %>% filter(SampleNo != 4 ) %>% ggboxplot(data = ., x = "Week", y = "T0_Diff", ylab = "Residue remaining since T0 (%)",  add = "jitter", fill = "Week", palette = "simpsons", xlab = FALSE) +  rotate_x_text(angle = 45) + stat_compare_means( method = "kruskal")   + scale_fill_manual(values=c("cornflowerblue", "azure4", "burlywood3" )) + ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T16", hide.ns = TRUE)

#histogram
p2.1 <- data_noref  %>% filter(SampleNo != 4 ) %>% filter(Week != "T0") %>% gghistogram(data =., x= "T0_Diff", fill = "Week", facet.by = "Week",add = "mean", rug = TRUE) + scale_fill_manual(values=c("cornflowerblue", "azure4", "burlywood3")) + scale_color_manual(values=c("cornflowerblue", "azure4", "burlywood3"))+ theme(legend.position = "none")


# Boxplot dieldrin cc by week
p1.2 <- data  %>% filter(SampleName != "t0_4.run" ) %>% ggboxplot(data = ., x = "Week", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = "jitter", fill = "Week", palette = "simpsons", xlab = FALSE, add.params = list(shape = 20, color = "Category")) + rotate_x_text(angle = 45) + ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T0", hide.ns = TRUE) + stat_compare_means(label.y = 1.25, method = "kruskal")  + scale_fill_manual(values=c("gray80","gold1", "cornflowerblue", "azure4", "burlywood3"))+ labs(colour = "")

#histogram
p2.2 <- data  %>% filter(SampleNo != 4 ) %>% gghistogram(data =., x= "Dieldrin", fill = "Week", palette = "simpsons", facet.by = "Week",add = "mean", rug = TRUE)+ scale_fill_manual(values=c("gray80","gold1", "cornflowerblue", "azure4", "burlywood3"))+ labs(colour = "") + theme(legend.position = "none")

ggarrange(p1.2, p2.2, p1.1, p2.1, ncol = 2, nrow = 2, common.legend = TRUE)


#p1 <- Sample_Peaks1 %>% filter(SampleNo != 4 ) %>% ggboxplot(data = ., x = "TWeeks", y = "Dieldrin", ylab = "calcualted dieldrin cc",  add = "jitter", fill = "TWeeks", palette = "simpsons", xlab = FALSE) +  rotate_x_text(angle = 45) + stat_compare_means( method = "kruskal")   + ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T0", hide.ns = TRUE)

#p2 <- Sample_Peaks1 %>% filter(SampleNo != 4 ) %>% ggboxplot(data = ., x = "TWeeks", y = "GCArea_Dieldrin", ylab = "GC AREA for dieldrin",  add = "jitter", fill = "TWeeks", palette = "simpsons", xlab = FALSE) +  rotate_x_text(angle = 45) + stat_compare_means( method = "kruskal")   + ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T0", hide.ns = TRUE)

#p3 <- Sample_Peaks1 %>% filter(SampleNo != 4 ) %>% ggboxplot(data = ., x = "TWeeks", y = "GCArea_DDD", ylab = "GC AREA for DDD",  add = "jitter", fill = "TWeeks", palette = "simpsons", xlab = FALSE) +  rotate_x_text(angle = 45) + stat_compare_means( method = "kruskal")   + ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "T0", hide.ns = TRUE)


```

Across all treatments there was no significant change in the mean concentrations after 9 month (39 weeks after treatment). However, in the last 3 months from T39 to T52 the mean concentration dropped by 9.5% (from 1.05 to 0.95 µg g^1^).  
  
The soil in the no-treatment control contained the highest concentrations and remained highest over time (with exception for T16). The dieldrin concentrations of the reference soil (airdried bulk soil) was at a similar level to the no-treatment control.  
  
The cause of this drop is likely related to the 'ploughing' of soils in the jars at T39. The incubation was not meant to go for 12 month and after 9 month of no change in concentration I decided to carefully break down all soil aggregated with a spoon and further re-treat the organic substrates (citric acid, inositol, fumaric acid, sodium formate and sodium acetate). As the 9.5 % drop in dieldrin concentration was across the board I suspected that it was related to the mixing of soil. 

The distribution of concentrations appears to be normal for T0, T39 and T52 but not for T16.

<br/>
```{r corplotfi2, fig.cap="Correlations of total respiration (µg CO~2~-C g^-1^ soil).", echo = FALSE, warning = FALSE, cache=TRUE, include=FALSE }
#Calculate the sum of CO2 produced per g of soil
df <- dataCO2  %>%  select(Samples, Week, µgCO2.Cgsoil) %>% tidyr::spread(Week, µgCO2.Cgsoil) %>% column_to_rownames("Samples") %>% rowSums()

#Create a df to compare the sum of CO2 produced with other variables
df <- data.frame(Treatment = dataCO2[c(1:44),]$Treatment, 
           TotalRespiration = df,  
           loss39to52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss39)),
           TotalLossT52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss)),
           TotalLossT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(loss)),
           TotalLossT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(loss)),
           PeakareaT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(GCArea_Dieldrin) ) , 
           PeakareaT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(GCArea_Dieldrin)),
          DieldrinT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(Dieldrin)), 
           DieldrinT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(Dieldrin)) )
ggcorrplot::ggcorrplot(cor(df %>% dplyr::select(-Treatment)))
```


```{r scatterplotfi2, fig.cap="Scatterplot of total dieldrin loss (%) and total respiration (µg CO~2~-C g^-1^ soil).", echo = FALSE, warning = FALSE, cache=TRUE, fig.width=9 }
#Calculate the sum of CO2 produced per g of soil
df <- dataCO2  %>%  select(Samples, Week, µgCO2.Cgsoil) %>% tidyr::spread(Week, µgCO2.Cgsoil) %>% column_to_rownames("Samples") %>% rowSums()

#Create a df to compare the sum of CO2 produced with other variables
df <- data.frame(Treatment = dataCO2[c(1:44),]$Treatment, 
           TotalRespiration = df,  
           loss39to52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss39)),
           TotalLossT52 = as_vector(data_noref %>% dplyr::filter(Week == "T52") %>% dplyr::select(loss)),
           TotalLossT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(loss)),
           TotalLossT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(loss)),
           PeakareaT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(GCArea_Dieldrin) ) , 
           PeakareaT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(GCArea_Dieldrin)),
          DieldrinT16 = as_vector(data_noref %>% dplyr::filter(Week == "T16") %>% dplyr::select(Dieldrin)), 
           DieldrinT39 = as_vector(data_noref %>% dplyr::filter(Week == "T39") %>% dplyr::select(Dieldrin)) )


p1 <- ggscatter(data = df, x= "TotalRespiration", y = "TotalLossT52", color = "Treatment", palette = "simpsons")+ stat_cor(method = "spearman",
   aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))
)
p2 <- ggscatter(data = df, x= "TotalRespiration", y = "TotalLossT39", color = "Treatment", palette = "simpsons") + stat_cor(method = "spearman",
   aes(label = paste(..rr.label.., ..p.label.., sep = "~`,`~"))
)

ggarrange(p1, p2, common.legend = TRUE)

```

Respiration is calculated as the sum of all currently measured traps (see next figure)

```{r lineplotCO2fig3, fig.width=8, fig.asp=1,  message=FALSE, echo = FALSE, cache=FALSE, warning = FALSE, fig.cap="Respiration  (µg CO~2~-C g^-1^ soil) across time. Error bars show the standard error of the mean of four replicates."}
#p1 <- dataCO2  %>% ggpubr::ggline(data = ., x = "Week_int", y = "µgCO2.Cgsoilday", ylab = "µgCO2.Cgsoilday", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

p2 <- dataCO2  %>% ggpubr::ggline(data = ., x = "Week_int", y = "µgCO2.Cgsoil", ylab = "µgCO2.Cgsoil", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

p3 <- dataCO2  %>% ggpubr::ggline(data = ., x = "Week_int", y = "µgCO2gsoilcum", ylab = "µgCO2.Cgsoil accumulated", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")


pdf(NULL)
g1 <- ggpubr::ggarrange(p2,p3, nrow = 2, ncol=1, common.legend = TRUE)
x = dev.off()
g1

```
  
There was a negative relationship of respiration and dieldrin loss. Dieldrin dissipated less in samples were microorganisms respired more carbon. This may be another hint that efficiency of carbon use may be linked to dieldrin degradation.

<br/>

```{r boxplfig4, echo=FALSE, fig.width=10, fig.asp=1,  message=FALSE, cache=TRUE, warning = FALSE, fig.cap="Boxplots of dieldrin concentrations by treatment, week/treatment (a) and treatment/week (b). Letters above boxplots indicate significantly different means at an 0.05 level (Fisher's least significant difference, holms corrected)."}

# Boxplot dieldrin cc by treatment with sig. labels
df1 <- data_noref %>% filter(SampleName != "t0_4.run" )
df1$Treatment <- factor(df1$Treatment)
kr.test <- with(df1,agricolae::kruskal(Dieldrin,Treatment,group=TRUE, p.adj="holm"))
levels  <- levels(df1$Treatment) %>% as.data.frame()
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)

#p1 <- data_noref %>% filter(SampleName != "t0_4.run" ) %>% ggboxplot(data = ., x = "Treatment", y = "Dieldrin",  ylab = "Dieldrin (µg/g) across all timepoints", add = "jitter", fill = "Treatment", palette = "simpsons", xlab = FALSE) + rotate_x_text(angle = 45) + stat_compare_means(label.y = 1.25, method = "kruskal")   + annotate("text", x = groups1$Treatment, y=c(1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3,1.3), label = label)

p2 <- ggboxplot( data_fltrd, x = "Treatment", y = "Dieldrin_trans",  ylab = "Dieldrin (log)", fill = "Week", palette = "simpsons") + rotate_x_text(angle = 45)

p3 <- ggboxplot( data_fltrd, x = "Week", y = "Dieldrin_trans", ylab = "Dieldrin (log)", fill = "Treatment", palette = "simpsons")+ rotate_x_text(angle = 45)

ggarrange(ggarrange(p3,ncol = 1, common.legend = TRUE), p2, ncol = 1, heights = c(0.5, 0.5), labels = "auto")


#ggboxplot( Sample_Peaks1, x = "TWeeks", y = "GCArea_Dieldrin",  ylab = "GCArea_Dieldrin", fill = "Treatment", palette = "simpsons") + rotate_x_text(angle = 45)

#ggboxplot( Sample_Peaks1, x = "TWeeks", y = "GCArea_DDD",  ylab = "GCArea_DDD", fill = "Treatment", palette = "simpsons") + rotate_x_text(angle = 45)
#ggboxplot( Sample_Peaks1, x = "Treatment", y = "GCArea_DDD",  ylab = "GCArea_DDD", fill = "TWeeks", palette = "simpsons") + rotate_x_text(angle = 45)
```

The treatment-comparison of dieldrin concentrations showed that biochar and the heat treatment were significantly lower compared to the control and all other treatments. It was also apparent the the biochar and heat treatment contained soil with lowest dieldrin concentrations from the start of the experiment. This meant that the effect of these treatments was immediate. For biochar this could be explained by lower extractability of dieldrin due to immediate sorption to biochar. 

<br/>  
```{r T0T16avg, echo=FALSE, fig.width=8, fig.asp=0.6,  message=FALSE, echo = FALSE, cache=TRUE, warning = FALSE, include=FALSE, fig.cap="Boxplots of dieldrin concentrations by treatment/week. Average values for T0 and T16 are shown."}

df <- data.frame(T0T16_avg = ((T0$Dieldrin + T16$Dieldrin) / 2), data %>% filter(Week == "T39") %>% select(Dieldrin), data %>% filter(Week == "T52") %>% select(Dieldrin), data %>% filter(Week == "T0") %>% select(Treatment), data %>% filter(Week == "T0") %>% select(SampleNo)  ) %>% rename(T39 = Dieldrin) %>%  rename(T52 = Dieldrin.1) 


mod <- lm(value ~ name, data = df %>% pivot_longer(cols = c("T0T16_avg", "T39", "T52")))
#summary(mod)

ggboxplot( data = df %>% pivot_longer(cols = c("T0T16_avg", "T39", "T52")), x = "Treatment", y = "value", fill = "name", palette = "simpsons", ylab = "Dieldrin (µg/g)") + rotate_x_text(angle = 45) + labs(fill = "Week")

```

<br/>
```{r lineplotfig5, fig.width=8, fig.asp=0.7,  message=FALSE, echo = FALSE, cache=FALSE, warning = FALSE, fig.cap="Dieldrin concentrations (log) across time. Error bars show the standard error of the mean of four replicates."}

l0 <- data_noref %>% filter(SampleName != "t0_4.run" ) %>% ggpubr::ggline(data = ., x = "Week_int", y = "Dieldrin_trans", ylab = "Dieldrin (log)", add = c("mean_se"), color = "Treatment", palette = "simpsons") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")

#l01 <- data  %>% filter(SampleNo != 4 ) %>% ggline(data = ., x = "Week_int", y = "T0_Diff", add = c("mean_se"), color = "Treatment", palette = "simpsons") + rotate_x_text(angle = 45) + stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal")



pdf(NULL)
g1 <- ggpubr::ggarrange(l0, nrow = 1, ncol=1, common.legend = TRUE)
x = dev.off()
g1

```

<br/>  
```{r line, include = FALSE, echo=FALSE, fig.width=8, fig.asp=1,  message=FALSE, cache=TRUE, warning = FALSE, fig.cap="Residues remaining since T0 in percent for two sets of treatments including the control (a,b). Error bars show the standard error of the mean of four replicates. Dieldrin concentrations (µg/g) over time."}

l1 <- data_noref  %>% filter(SampleNo != 4 ) %>% filter(Week != "T52" ) %>% filter(Treatment %in% c("Control", "Heat", "Lime", "Biochar", "PoultryLitter","H2O2")) %>% ggpubr::ggline(data =., x = "Week_int", y = "T0_Diff", ylab = "Residue remaining since T0 (%)", add = c("mean_se"), color = "Treatment", palette = "simpsons",xlab = FALSE)  + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal") + ggpubr::rotate_x_text(angle = 45) 

s1 <- data_noref  %>% filter(SampleName != "t0_4.run" ) %>% filter(Week != "T52" ) %>% filter(Treatment %in% c("Control", "Heat", "Lime", "Biochar", "PoultryLitter","H2O2")) %>% ggpubr::ggscatter(data=., x = "Week_int", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = c("reg.line"), color = "Treatment", palette = "simpsons",xlab = FALSE ) + ggpubr::rotate_x_text(angle = 45)

l2 <-   data_noref  %>% filter(SampleNo != 4 ) %>% filter(Week != "T52" ) %>% filter(Treatment %in% c("Control", "CitricAcid", "Inositol","SodiumFormate", "SodiumAcetate","FumaricAcid")) %>% ggpubr::ggline(data =., x = "Week_int", y = "T0_Diff", ylab = c("Residue remaining since T0 (%)"), add = c("mean_se"), color = "Treatment", palette = "simpsons",xlab = FALSE) +  ggpubr::rotate_x_text(angle = 45)+ ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal") 

s2 <-  data_noref  %>% filter(SampleName != "t0_4.run" ) %>% filter(Week != "T52" )%>% filter(Treatment %in% c("Control", "CitricAcid", "Inositol","SodiumFormate", "SodiumAcetate","FumaricAcid")) %>% ggpubr::ggscatter(data=., x = "Week_int", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = c("reg.line"), color = "Treatment", palette = "simpsons",xlab = FALSE) + ggpubr::rotate_x_text(angle = 45)


pdf(NULL)
x = dev.off()
ggpubr::ggarrange(ncol =1, nrow=2, ggarrange(l1, s1, ncol = 2, nrow =1, common.legend = TRUE), ggarrange(l2, s2, ncol =2, nrow =1, common.legend = TRUE), labels = "auto" ) 

```
<br/>

```{r line23952, include = FALSE, echo=FALSE, fig.width=8, fig.asp=1,  message=FALSE, cache=TRUE, warning = FALSE, fig.cap="Residues remaining since T39 (9 month) in percent for two sets of treatments including the control (a,b). Error bars show the standard error of the mean of four replicates. Dieldrin concentrations (µg/g) over time."}
l1 <- data_noref  %>% filter(SampleNo != 4 ) %>% filter(Week %in% c("T39", "T52" )) %>% filter(Treatment %in% c("Control", "Heat", "Lime", "Biochar", "PoultryLitter","H2O2")) %>% ggpubr::ggline(data =., x = "Week_int", y = "T39_Diff", ylab = c("Residue remaining since T39 (%)"), add = c("mean_se"), color = "Treatment", palette = "simpsons",xlab = FALSE)  + ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal") + ggpubr::rotate_x_text(angle = 45) 

s1 <- data_noref  %>% filter(SampleName != "t0_4.run" ) %>% filter(Week %in% c("T39", "T52" )) %>% filter(Treatment %in% c("Control", "Heat", "Lime", "Biochar", "PoultryLitter","H2O2")) %>% ggpubr::ggscatter(data=., x = "Week_int", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = c("reg.line"), color = "Treatment", palette = "simpsons",xlab = FALSE ) + ggpubr::rotate_x_text(angle = 45)

l2 <-   data_noref  %>% filter(SampleNo != 4 ) %>% filter(Week %in% c("T39", "T52" )) %>% filter(Treatment %in% c("Control", "CitricAcid", "Inositol","SodiumFormate", "SodiumAcetate","FumaricAcid")) %>% ggpubr::ggline(data =., x = "Week_int", y = "T39_Diff", ylab = c("Residue remaining since T39 (%)"),  add = c("mean_se"), color = "Treatment", palette = "simpsons",xlab = FALSE) +  ggpubr::rotate_x_text(angle = 45)+ ggpubr::stat_compare_means(aes(group = Treatment), label = "p.signif", method = "kruskal") 

s2 <-  data_noref  %>% filter(SampleName != "t0_4.run" ) %>% filter(Week %in% c("T39", "T52" ))%>% filter(Treatment %in% c("Control", "CitricAcid", "Inositol","SodiumFormate", "SodiumAcetate","FumaricAcid")) %>% ggpubr::ggscatter(data=., x = "Week_int", y = "Dieldrin", ylab = "Dieldrin (µg/g)", add = c("reg.line"), color = "Treatment", palette = "simpsons",xlab = FALSE) + ggpubr::rotate_x_text(angle = 45)

pdf(NULL)
x = dev.off()
ggpubr::ggarrange(ncol =1, nrow=2, ggarrange(l1, s1, ncol = 2, nrow =1, common.legend = TRUE), ggarrange(l2, s2, ncol =2, nrow =1, common.legend = TRUE), labels = "auto" ) 

```
<br/>

# Dieldrin loss
```{r dlossfig6, echo=FALSE, fig.width=10, fig.asp=1, include=TRUE, fig.cap="Residues loss in percent. At T39 the soil was ploughed inside the jars. Two timelines were therefore assessed separately (T0−T39 and T39−T52). Error bars show the standard error of the mean of four replicates. Letters show differences of the mean after multiple comparison tests (Fisher's least significant difference, holm correct *p* value)."}
library(ggpubr)
library(agricolae)

#Loss plot for week 39
df <- data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T39" )
df$Treatment <- factor(df$Treatment)
kr.test <- with(df,kruskal(loss,Treatment,group=TRUE, p.adj="holm"))
levels  <- base::levels(df$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
p1 <- data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T39" ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%)") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 15) + geom_hline(yintercept = 0, linetype = 2)  + annotate("text", x = groups1$Treatment, y=c(20,20,20,20,20,20,20,20,20,20,20), label = label)+ ggtitle("Dieldrin loss from T0 to T39")
#+ ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "Control", hide.ns = TRUE)

#Loss plot for week 52
df <- data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T52" )
df$Treatment <- factor(df$Treatment)
kr.test <- with(df,kruskal(loss,Treatment,group=TRUE, p.adj="holm"))
levels  <- levels(df$Treatment) %>% as.data.frame()%>% filter(. != "Reference")
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)

#p2 <- data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T52" ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%)") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 23) + geom_hline(yintercept = 0, linetype = 2)  + annotate("text", x = groups1$Treatment, y=c(20,20,20,20,20,20,20,20,20,20,20), label = label) + ggtitle("Dieldrin loss from T0 to T52")
#+ ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "Control", hide.ns = TRUE)

## loss plot from week 52 since week 39 
df <-  data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T52" )
df$Treatment <- factor(df$Treatment)
kr.test <- with(df,kruskal(loss39,Treatment,group=TRUE, p.adj="holm"))
levels  <- levels(df$Treatment) %>% as.data.frame()%>% filter(. != "Reference")
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
p3 <- data_noref %>% filter(SampleNo != 4 ) %>% filter(Week == "T52" ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss39",  fill = "Treatment", palette = "simpsons", facet.by = "Week", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%) T39 - T52") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 23) + geom_hline(yintercept = 0, linetype = 2) + annotate("text", x = groups1$Treatment, y=c(20,20,20,20,20,20,20,20,20,20,20), label = label) + ggtitle("Dieldrin loss from T39 to T52")


## loss plot from week 39 using average values of T0 and T16 with dunn test labels
# Do not include - not sure about interpretation
df1 <- data.frame(T0T16_avg = ((T0$Dieldrin + T16$Dieldrin) / 2), data %>% filter(Week == "T39") %>% select(Dieldrin), data %>% filter(Week == "T52") %>% select(Dieldrin), data %>% filter(Week == "T0") %>% select(Treatment), data %>% filter(Week == "T0") %>% select(SampleNo)  ) %>% rename(T39 = Dieldrin) %>%  rename(T52 = Dieldrin.1) 

df <-  df1 %>% dplyr::mutate(loss = (T0T16_avg - T39) / T0T16_avg *100 )
df$Treatment <- factor(df$Treatment)
kr.test <- with(df,kruskal(loss,Treatment,group=TRUE, p.adj="holm"))
levels  <- levels(df$Treatment) %>% as.data.frame() 
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
#dunntest.df <- rstatix::dunn_test(df, loss ~ Treatment)
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)

#p4 <- df1 %>% dplyr::mutate(loss = (T0T16_avg - T39) / T0T16_avg *100 ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%) T0T16_avg - T39") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 10) + geom_hline(yintercept = 0, linetype = 2) + annotate("text", x = groups1$Treatment, y=c(20,20,20,20,20,20,20,20,20,20,20), label = label)

#pwc <- df %>% mutate(loss = (T0T16_avg - T52) / T0T16_avg *100 ) %>% 
#  dunn_test(loss ~ Treatment, p.adjust.method = "holm") 

## loss plot from week 52 using average values of T0 and T16 with dunn test labels
# Do not include - not sure about interpretation
df1 <- data.frame(T0T16_avg = ((T0$Dieldrin + T16$Dieldrin) / 2), data %>% filter(Week == "T39") %>% select(Dieldrin), data %>% filter(Week == "T52") %>% select(Dieldrin), data %>% filter(Week == "T0") %>% select(Treatment), data %>% filter(Week == "T0") %>% select(SampleNo)  ) %>% rename(T39 = Dieldrin) %>%  rename(T52 = Dieldrin.1) 

df <-  df1 %>% dplyr::mutate(loss = (T0T16_avg - T52) / T0T16_avg *100 )
df$Treatment <- factor(df$Treatment)
kr.test <- with(df,kruskal(loss,Treatment,group=TRUE, p.adj="holm"))
levels  <- levels(df$Treatment) %>% as.data.frame()%>% filter(. != "Reference")
groups1 <- kr.test$groups %>% rownames_to_column("Treatment")
groups1 <- groups1[match(levels$., groups1$Treatment),]
label <- as.vector(groups1$groups)
#p5 <- df1 %>% mutate(loss = (T0T16_avg - T52) / T0T16_avg *100 ) %>%  ggpubr::ggbarplot(data =., x = "Treatment", y = "loss",  fill = "Treatment", palette = "simpsons", legend = "none",add = c("mean_se"), lab.vjust = -2, xlab = FALSE, ylab = "Dieldrin loss (%) T0T16_avg - T52") + ggpubr::rotate_x_text(angle = 45) + ggpubr::stat_compare_means(method = "kruskal", label.y = 22) + geom_hline(yintercept = 0, linetype = 2) + annotate("text", x = groups1$Treatment, y=c(20,20,20,20,20,20,20,20,20,20,20), label = label)+ ggpubr::stat_compare_means(label = "..p.signif..", method = "t.test",  ref.group = "Control", hide.ns = TRUE)


ggarrange(p1,p3, ncol = 1)



```


```{r ordinarymodels, message=FALSE, echo = TRUE, warning = FALSE, include=FALSE}

intercept <- 1
df <- data_noref %>% filter(Week != "T0") %>% filter(SampleNo != 4 )
mod2 <- lm(I((T0_Diff) - intercept) ~  Treatment, data = df)
summary(mod2)
car::Anova(mod2, type = 3)

intercept <- data_noref %>% filter(SampleName != "t0_4.run" ) %>% summarise(meanD = mean(Dieldrin))
intercept <- intercept$meanD
df <- data %>% filter(SampleName != "t0_4.run" )
mod3 <- lm(I(Dieldrin - intercept) ~ Treatment, data = df)
summary(mod3)
car::Anova(mod2, type = 3)

```

# Summary 
https://www.datanovia.com/en/lessons/repeated-measures-anova-in-r/
```{r rmanova, echo=FALSE, message=FALSE, echo = TRUE, cache=TRUE, warning = FALSE, include=TRUE}
# Normality
library(rstatix)
#data %>% filter(SampleName != "t0_4.run" ) %>% 
#  group_by(Week) %>%
#   rstatix::shapiro_test(Dieldrin)

# outliers
#data  %>%
#  group_by(Week) %>%
#  rstatix::identify_outliers(Dieldrin) %>% select(Week,Treatment, Dieldrin, is.outlier, is.extreme)

# Summary mean and sd
data %>% filter(SampleName != "t0_4.run" ) %>%
  group_by(Week) %>%
  get_summary_stats(Dieldrin, type = "mean_sd")
#Transform dieldrin values to improve distribution in order to meet normality assumption
#remove 1 extreme outlier sample (Control, 1.33µg/g dieldrin)
```

```{r rmanova2, echo=FALSE, message=FALSE, echo = TRUE, cache=TRUE, warning = FALSE, include=FALSE}
data_fltrd %>%
  group_by(Week) %>%
   rstatix::shapiro_test(Dieldrin_trans) 

data_fltrd %>%
  group_by(Week) %>%
   rstatix::shapiro_test(Dieldrin)

#Go with log transform for now
```

```{r rmanova3, echo=TRUE, message=FALSE, echo = TRUE, cache=TRUE, warning = FALSE, include=FALSE}
library(rstatix)

res.aov <- anova_test(data = data_fltrd, dv = Dieldrin_trans, between = c(Week, Treatment))

rstatix::get_anova_table(res.aov)

pwc <- data_fltrd %>%
  pairwise_t_test(
    Dieldrin_trans ~ Week, paired = FALSE,
    p.adjust.method = "bonferroni"
    )

bxp <- ggboxplot(data_fltrd, x = "Week", y = "Dieldrin_trans", add = "point")

pwc <- pwc %>% add_xy_position(x = "Week")
bxp <- bxp + 
  stat_pvalue_manual(pwc) +
  labs(
    subtitle = get_test_label(res.aov, detailed = TRUE),
    caption = get_pwc_label(pwc)
  )
bxp
```

```{r rmanova4, echo=TRUE, message=FALSE, echo = TRUE, cache=TRUE, warning = FALSE, include=FALSE}
data_fltrd %>%
  group_by(Treatment, Week) %>%
  get_summary_stats(Dieldrin_trans, type = "mean_sd")

data_fltrd %>%
  group_by(Treatment, Week) %>%
  identify_outliers(Dieldrin) %>% dplyr::select(Week, Treatment, Dieldrin, is.outlier, is.extreme)

ggqqplot(data_fltrd, "Dieldrin_trans", ggtheme = theme_bw()) +
  facet_grid(Week ~ Treatment, labeller = "label_both")
```


```{r rmanova5, echo=TRUE, message=FALSE, eval= FALSE, cache=TRUE, warning = FALSE, include = FALSE}
## A repeated measures ANOVA (this is not valid as I used replicates as individuals)
#There were no individual soils that were treated differently but wanted to see what happens if we assume that each replicate was the same individual

data_sel <- data %>% dplyr::select(Replicate, Treatment, Week, Dieldrin) %>% as_tibble()
anova_test(  data = data_sel, dv = Dieldrin, wid = Replicate,
  within = c(Treatment, Week) )

```


```{r lme, include=FALSE, eval=FALSE, fig.width=10, fig.asp= 1, message=FALSE, echo = TRUE, warning = FALSE, include=FALSE}
library(lme4)
library(lmerTest)
library(car)
library(rafalib)
library(visreg)
library(sjPlot)
library(sciplot)
library(nlme)
library(MASS)
library(ggpubr)
theme_set(theme_bw())


M <- gls(log(Dieldrin) ~ Treatment, data = data_fltrd)
M0 <- lme(log(Dieldrin)  ~ Treatment,  random =~ 1 | SampleNo, data = data_fltrd)
M1 <- lme(log(Dieldrin)  ~ Treatment,  random =~ 1 | Week_int/SampleNo, data = data_fltrd)
M2 <- lme(log(Dieldrin)  ~  Treatment,  random =~ 1 | SampleNo/Week_int, data = data_fltrd)
M3 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | SampleNo/InjectionDate, data = data_fltrd)
M4 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | InjectionDate, data = data_fltrd)
M5 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | InjectionDate/SampleNo, data = data_fltrd)
M6 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | Week_int/InjectionDate, data = data_fltrd)
M7 <- lme(log(Dieldrin)  ~ Treatment,  random =~  1 | Week_int, data = data_fltrd)
anova(M, M0, M1, M2, M3, M4, M5, M6, M7)

M <- gls(log1p(Dieldrin) ~ Treatment + Week, data = data)
M0 <- lme(log1p(Dieldrin)  ~ Treatment + Week,  random =~ 1 | SampleNo, data = data)
M1 <- lme(log1p(Dieldrin)  ~ Treatment + Week,  random =~  1 | InjectionDate, data = data)
#M2 <- lme(log1p(Dieldrin_cor)  ~ Treatment + Week,  random =~  1 | Week_int, data = data)
anova(M, M0, M1)


M1 <-  lme(log(Dieldrin)  ~ Treatment,  random =~  1 | Week_int/InjectionDate, data = data_fltrd)

E <- resid(M1, type = 'normalized') 
shapiro.test(E)
E <- data.frame(E = E)

Ehist <- ggplot(E, aes(x=(E))) +  geom_histogram(color="black", fill="black") + ggtitle("Residuals Histogram")

F0 <- fitted(M1)
df <- data.frame(F0 = F0, E = E, Treatment = data_fltrd$Treatment, Week_int = data_fltrd$Week_int, Dieldrin = data_fltrd$Dieldrin_trans) 

residscatter <- ggscatter(data= df, x = "F0", y = "E", xlab = "Fitted values", ylab = "Residuals") + ggtitle("Residuals distribution")

D_scatter <- ggscatter(data= df, x = "Dieldrin", y = "E", xlab = "Dieldrin_trans", ylab = "Residuals", add = ("reg.line"))

trt_bxp <- ggboxplot(data= df, x = "Treatment", y = "E", xlab = "Treatment fitted values", ylab = "Residuals", add = ("jitter"))+ rotate_x_text(angle = 45)

Week_scatter <- ggscatter(data= df, x = "Week_int", y = "E", xlab = "Week_int", ylab = "Residuals", add = ("reg.line"))

ggarrange(Ehist, residscatter, D_scatter, Week_scatter, trt_bxp, nrow = 3, ncol = 2)
```
  
 
```{r, include=FALSE, eval=FALSE, include = FALSE}
## Auto-correlation plot
acf(E)
```

<br/> 
```{r, include=FALSE, eval=FALSE,message=FALSE, echo = FALSE, warning = FALSE, include = FALSE}
summary(M1)
```
